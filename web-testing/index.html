
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../metadata-context/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.13">
    
    
      
        <title>Testing - sda-spring-boot-commons</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e359304.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="sda-spring-boot-commons" class="md-header__button md-logo" aria-label="sda-spring-boot-commons" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            sda-spring-boot-commons
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Testing
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="sda-spring-boot-commons" class="md-nav__button md-logo" aria-label="sda-spring-boot-commons" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    sda-spring-boot-commons
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration-2-to-3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Migrate to v3
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../starter-web/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Starter Web
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../starter-mongodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Starter MongoDB
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../starter-kafka/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Starter Kafka
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../starter-s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Starter S3
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security Hardening
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../asyncapi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AsyncAPI
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cloudevents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud Events
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../metadata-context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metadata Context
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Testing
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#test-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Test Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#management-port" class="md-nav__link">
    <span class="md-ellipsis">
      Management Port
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#provided-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      Provided Libraries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication-and-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Authentication and Authorization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-and-validating-up-to-date-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      Generating and Validating up-to-date Documentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      MongoDB
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#test-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Test Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#management-port" class="md-nav__link">
    <span class="md-ellipsis">
      Management Port
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#provided-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      Provided Libraries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication-and-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Authentication and Authorization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-and-validating-up-to-date-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      Generating and Validating up-to-date Documentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      MongoDB
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h1>
<p>The module <a href="https://central.sonatype.com/artifact/org.sdase.commons.spring.boot/sda-commons-web-testing"><code>sda-commons-web-testing</code></a>
provides a few helpers to support integration tests related to the features provided by SDA Spring
Boot Commons and propagated patterns of SDA SE.</p>
<h2 id="test-setup">Test Setup<a class="headerlink" href="#test-setup" title="Permanent link">&para;</a></h2>
<h3 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permanent link">&para;</a></h3>
<div class="language-groovy highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">dependencies</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="n">implementation</span><span class="w"> </span><span class="n">enforcedPlatform</span><span class="o">(</span><span class="s2">&quot;org.sdase.commons.spring.boot:sda-commons-dependencies:$sdaSpringCommonsVersion&quot;</span><span class="o">)</span>
<span class="w">  </span><span class="n">implementation</span><span class="w"> </span><span class="n">enforcedPlatform</span><span class="o">(</span><span class="s2">&quot;org.sdase.commons.spring.boot:sda-commons-bom:$sdaSpringCommonsVersion&quot;</span><span class="o">)</span>

<span class="w">  </span><span class="n">implementation</span><span class="w"> </span><span class="s1">&#39;org.sdase.commons.spring.boot:sda-commons-starter-web&#39;</span>

<span class="w">  </span><span class="n">testImplementation</span><span class="w"> </span><span class="s1">&#39;org.sdase.commons.spring.boot:sda-commons-web-testing&#39;</span>
<span class="o">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="management-port">Management Port<a class="headerlink" href="#management-port" title="Permanent link">&para;</a></h3>
<p>The default configuration of Spring's Actuator with this library is a separate management port.
In tests, this causes some issues that
<a href="https://github.com/spring-projects/spring-boot/issues/4424#issuecomment-420276806">need configuration</a>.</p>
<p><code>@SpringBootTest</code>'s need to be marked with <code>@DirtiesContext</code> or define <code>management.server.port=0</code>
either in <code>@SpringBootTest(properties = "…")</code> or in <code>src/test/resources/application.properties</code>.</p>
<h3 id="provided-libraries">Provided Libraries<a class="headerlink" href="#provided-libraries" title="Permanent link">&para;</a></h3>
<p><code>sda-commons-web-test</code> comes with managed and aligned transitive dependencies, that can be used
without adding them to the dependency tree, including:</p>
<ul>
<li><code>org.springframework.boot:spring-boot-starter-test</code></li>
<li><code>org.springframework.cloud:spring-cloud-contract-wiremock</code></li>
<li><code>org.junit.jupiter:junit-jupiter</code></li>
<li><code>org.assertj:assertj-core</code></li>
<li><code>com.jayway.jsonpath:json-path</code></li>
<li><code>org.awaitility:awaitility</code></li>
<li><code>org.mockito:mockito-junit-jupiter</code></li>
</ul>
<h2 id="authentication-and-authorization">Authentication and Authorization<a class="headerlink" href="#authentication-and-authorization" title="Permanent link">&para;</a></h2>
<p>The security concept of SDA SE has a strict separation of <a href="../starter-web/#authentication">authentication</a>
and <a href="../starter-web/#authorization">authorization</a>.
The identity of a user is verified in the application by validating a JWT from an OIDC provider.
The authorization is delegated to an Open Policy Agent sidecar with policies for an actual
environment.
The service implementation grants access based on constraints received from the policy, not on roles
which may be different in each environment or not even available.</p>
<p><code>sda-commons-web-testing</code> provides <code>ApplicationContextInitializer</code>s for integration test contexts to
work with authenticated users and mocked authorization decisions, including constraints as well as
for disabling the security mechanism.</p>
<details class="example">
<summary>Mocking Authentication and Authorization Constraints</summary>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import static</span><span class="w"> </span><span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.ws.rs.HttpMethod</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.BeforeEach</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.testing.auth.AuthMock</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.testing.auth.EnableSdaAuthMockInitializer</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.web.server.LocalServerPort</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.ContextConfiguration</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span><span class="p">(</span>
<span class="w">    </span><span class="n">webEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringBootTest</span><span class="p">.</span><span class="na">WebEnvironment</span><span class="p">.</span><span class="na">RANDOM_PORT</span><span class="p">,</span>
<span class="w">    </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;management.server.port=0&quot;</span><span class="p">)</span>
<span class="nd">@ContextConfiguration</span><span class="p">(</span><span class="n">initializers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">EnableSdaAuthMockInitializer</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
<span class="kd">class</span> <span class="nc">AuthTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@LocalServerPort</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Autowired</span><span class="w"> </span><span class="n">AuthMock</span><span class="w"> </span><span class="n">authMock</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@BeforeEach</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">authMock</span><span class="p">.</span><span class="na">reset</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldRejectRequest</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">authMock</span><span class="p">.</span><span class="na">authorizeRequest</span><span class="p">().</span><span class="na">withHttpMethod</span><span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">).</span><span class="na">withPath</span><span class="p">(</span><span class="s">&quot;/cars&quot;</span><span class="p">).</span><span class="na">deny</span><span class="p">();</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">authMock</span><span class="p">.</span><span class="na">authentication</span><span class="p">().</span><span class="na">authenticatedClient</span><span class="p">().</span><span class="na">getForEntity</span><span class="p">(</span><span class="n">carsApiUrl</span><span class="p">(),</span><span class="w"> </span><span class="n">Cars</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">FORBIDDEN</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldAllowWithConstraints</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">authMock</span>
<span class="w">        </span><span class="p">.</span><span class="na">authorizeRequest</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">withHttpMethod</span><span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">withPath</span><span class="p">(</span><span class="s">&quot;/cars&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">allowWithConstraint</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;drivers&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;driver-123&quot;</span><span class="p">)));</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">authMock</span>
<span class="w">            </span><span class="p">.</span><span class="na">authentication</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">withSubject</span><span class="p">(</span><span class="s">&quot;driver-123&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">authenticatedClient</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">getForEntity</span><span class="p">(</span><span class="n">carsApiUrl</span><span class="p">(),</span><span class="w"> </span><span class="n">Cars</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">carsApiUrl</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;http://localhost:%s/api/cars&quot;</span><span class="p">.</span><span class="na">formatted</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<details class="example">
<summary>Disable Authentication and Authorization</summary>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import static</span><span class="w"> </span><span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.testing.auth.DisableSdaAuthInitializer</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.web.client.TestRestTemplate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.web.server.LocalServerPort</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.ContextConfiguration</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span><span class="p">(</span>
<span class="w">    </span><span class="n">webEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringBootTest</span><span class="p">.</span><span class="na">WebEnvironment</span><span class="p">.</span><span class="na">RANDOM_PORT</span><span class="p">,</span>
<span class="w">    </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;management.server.port=0&quot;</span><span class="p">)</span>
<span class="nd">@ContextConfiguration</span><span class="p">(</span><span class="n">initializers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">DisableSdaAuthInitializer</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
<span class="kd">class</span> <span class="nc">DisabledAuthTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@LocalServerPort</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Autowired</span><span class="w"> </span><span class="n">TestRestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldGetResourceWithoutAuthentication</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForEntity</span><span class="p">(</span><span class="n">carsApiUrl</span><span class="p">(),</span><span class="w"> </span><span class="n">Cars</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">carsApiUrl</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;http://localhost:%s/api/cars&quot;</span><span class="p">.</span><span class="na">formatted</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<p>Usually constraints are handled in <code>@Controllers</code> who call the allowed business functions with
applicable parts of the constraints model.
Integration tests with HTTP calls may not be the best solution to test complex logic on constraints.
In such cases the constraints model can be mocked.</p>
<details class="example">
<summary>Mocking Constraints for Unit Tests Compared to Integration Test</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">SomeControllerTest</label><label for="__tabbed_1_2">SomeControllerIntegrationTest</label><label for="__tabbed_1_3">SomeConstraints</label><label for="__tabbed_1_4">SomeController</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import static</span><span class="w"> </span><span class="nn">org.mockito.Mockito.times</span><span class="p">;</span>
<span class="kn">import static</span><span class="w"> </span><span class="nn">org.mockito.Mockito.verify</span><span class="p">;</span>
<span class="kn">import static</span><span class="w"> </span><span class="nn">org.mockito.Mockito.verifyNoMoreInteractions</span><span class="p">;</span>
<span class="kn">import static</span><span class="w"> </span><span class="nn">org.mockito.Mockito.when</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.app.constraints.test.SomeConstraints</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.app.constraints.test.SomeController</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.app.constraints.test.SomeService</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.mock.mockito.MockBean</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span><span class="p">(</span><span class="n">classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SomeController</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">webEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringBootTest</span><span class="p">.</span><span class="na">WebEnvironment</span><span class="p">.</span><span class="na">MOCK</span><span class="p">)</span>
<span class="nd">@AutoConfigureMockMvc</span>
<span class="kd">class</span> <span class="nc">SomeControllerTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nd">@MockBean</span><span class="w"> </span><span class="n">SomeConstraints</span><span class="w"> </span><span class="n">mockConstraints</span><span class="p">;</span>
<span class="w">  </span><span class="nd">@MockBean</span><span class="w"> </span><span class="n">SomeService</span><span class="w"> </span><span class="n">someService</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Autowired</span><span class="w"> </span><span class="n">SomeController</span><span class="w"> </span><span class="n">constraintsAwareController</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldBeAdmin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">mockConstraints</span><span class="p">.</span><span class="na">isAdmin</span><span class="p">()).</span><span class="na">thenReturn</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">constraintsAwareController</span><span class="p">.</span><span class="na">getUserCategory</span><span class="p">();</span>
<span class="w">    </span><span class="n">verify</span><span class="p">(</span><span class="n">someService</span><span class="p">,</span><span class="w"> </span><span class="n">times</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="na">doAsAdmin</span><span class="p">();</span>
<span class="w">    </span><span class="n">verifyNoMoreInteractions</span><span class="p">(</span><span class="n">someService</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldBeUser</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">mockConstraints</span><span class="p">.</span><span class="na">isAdmin</span><span class="p">()).</span><span class="na">thenReturn</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="n">constraintsAwareController</span><span class="p">.</span><span class="na">getUserCategory</span><span class="p">();</span>
<span class="w">    </span><span class="n">verify</span><span class="p">(</span><span class="n">someService</span><span class="p">,</span><span class="w"> </span><span class="n">times</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="na">doAsUser</span><span class="p">();</span>
<span class="w">    </span><span class="n">verifyNoMoreInteractions</span><span class="p">(</span><span class="n">someService</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import static</span><span class="w"> </span><span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.app.constraints.test.App</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.testing.auth.AuthMock</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.testing.auth.EnableSdaAuthMockInitializer</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.web.server.LocalServerPort</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.ContextConfiguration</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span><span class="p">(</span>
<span class="w">    </span><span class="n">classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">App</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
<span class="w">    </span><span class="n">webEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringBootTest</span><span class="p">.</span><span class="na">WebEnvironment</span><span class="p">.</span><span class="na">RANDOM_PORT</span><span class="p">,</span>
<span class="w">    </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;management.server.port=0&quot;</span><span class="p">)</span>
<span class="nd">@ContextConfiguration</span><span class="p">(</span><span class="n">initializers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">EnableSdaAuthMockInitializer</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
<span class="kd">class</span> <span class="nc">SomeControllerIntegrationTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nd">@LocalServerPort</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Autowired</span><span class="w"> </span><span class="n">AuthMock</span><span class="w"> </span><span class="n">authMock</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldBeAdmin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">authMock</span><span class="p">.</span><span class="na">authorizeAnyRequest</span><span class="p">().</span><span class="na">allowWithConstraint</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">authMock</span><span class="p">.</span><span class="na">authentication</span><span class="p">().</span><span class="na">authenticatedClient</span><span class="p">().</span><span class="na">getForEntity</span><span class="p">(</span><span class="n">serviceUrl</span><span class="p">(),</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">actual</span><span class="p">.</span><span class="na">getBody</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldBeUser</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">authMock</span><span class="p">.</span><span class="na">authorizeAnyRequest</span><span class="p">().</span><span class="na">allowWithConstraint</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">));</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">authMock</span><span class="p">.</span><span class="na">authentication</span><span class="p">().</span><span class="na">authenticatedClient</span><span class="p">().</span><span class="na">getForEntity</span><span class="p">(</span><span class="n">serviceUrl</span><span class="p">(),</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">actual</span><span class="p">.</span><span class="na">getBody</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">serviceUrl</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;http://localhost:%s/api/me/category&quot;</span><span class="p">.</span><span class="na">formatted</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.auth.opa.AbstractConstraints</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.auth.opa.Constraints</span><span class="p">;</span>

<span class="nd">@Constraints</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SomeConstraints</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractConstraints</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAdmin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SomeConstraints</span><span class="w"> </span><span class="nf">setAdmin</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">admin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SomeController</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SomeConstraints</span><span class="w"> </span><span class="n">constraints</span><span class="p">;</span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SomeService</span><span class="w"> </span><span class="n">someService</span><span class="p">;</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">SomeController</span><span class="p">(</span><span class="n">SomeConstraints</span><span class="w"> </span><span class="n">constraints</span><span class="p">,</span><span class="w"> </span><span class="n">SomeService</span><span class="w"> </span><span class="n">someService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">constraints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constraints</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">someService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">someService</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/me/category&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getUserCategory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">constraints</span><span class="p">.</span><span class="na">isAdmin</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">someService</span><span class="p">.</span><span class="na">doAsAdmin</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">someService</span><span class="p">.</span><span class="na">doAsUser</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</details>
<h2 id="generating-and-validating-up-to-date-documentation">Generating and Validating up-to-date Documentation<a class="headerlink" href="#generating-and-validating-up-to-date-documentation" title="Permanent link">&para;</a></h2>
<p>At SDA SE it is common to publish generated documentation like OpenAPI or AsyncAPI in the repository.
From there it's picked up by our developer portal based on Backstage.</p>
<p><code>sda-commons-web-testing</code> provides <code>GoldenFileAssertions</code> to validate in a test that such
documentation is up-to-date and updates it when run locally.</p>
<details class="example">
<summary>Generating and updating OpenAPI</summary>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.file.Paths</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.web.testing.GoldenFileAssertions</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.web.client.TestRestTemplate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.web.server.LocalServerPort</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span><span class="p">(</span>
<span class="w">    </span><span class="n">webEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringBootTest</span><span class="p">.</span><span class="na">WebEnvironment</span><span class="p">.</span><span class="na">RANDOM_PORT</span><span class="p">,</span>
<span class="w">    </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;springdoc.packagesToScan=org.sdase.commons.spring.boot.web.app.example&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;management.server.port=0&quot;</span>
<span class="w">    </span><span class="p">})</span>
<span class="kd">class</span> <span class="nc">OpenApiDocumentationTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nd">@LocalServerPort</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Autowired</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="n">TestRestTemplate</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldHaveSameOpenApiInRepository</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">expectedOpenApi</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;http://localhost:%s/api/openapi.yaml&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">),</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">actualOpenApiInRepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;openapi.yaml&quot;</span><span class="p">).</span><span class="na">toAbsolutePath</span><span class="p">();</span>

<span class="w">    </span><span class="n">GoldenFileAssertions</span><span class="p">.</span><span class="na">assertThat</span><span class="p">(</span><span class="n">actualOpenApiInRepository</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">hasYamlContentAndUpdateGolden</span><span class="p">(</span><span class="n">expectedOpenApi</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<h2 id="mongodb">MongoDB<a class="headerlink" href="#mongodb" title="Permanent link">&para;</a></h2>
<p>It is recommended to test with an embedded MongoDB using Flapdoodle's Spring Boot module and the
SDA Spring Boot Commons testing module:</p>
<div class="language-groovy highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">dependencies</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="n">testImplementation</span><span class="w"> </span><span class="s1">&#39;de.flapdoodle.embed:de.flapdoodle.embed.mongo.spring3x&#39;</span>
<span class="w">  </span><span class="n">testImplementation</span><span class="w"> </span><span class="s1">&#39;org.sdase.commons.spring.boot:sda-commons-web-testing&#39;</span>
<span class="o">}</span>
</code></pre></div></td></tr></table></div>
<p>Flapdoodle will start a MongoDB server and configures the connection for Spring Boot tests.
The MongoDB version can be selected with (test) application properties:</p>
<div class="language-properties highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">de.flapdoodle.mongodb.embedded.version</span><span class="o">=</span><span class="s">4.4.1</span>
</code></pre></div></td></tr></table></div>
<p>To skip Flapdoodle's autoconfiguration and use a provided database (e.g. an AWS DocumentDB), the
property <code>test.mongodb.connection.string</code> (or environment variable <code>TEST_MONGODB_CONNECTION_STRING</code>)
can be used to provide a complete <a href="https://docs.mongodb.com/manual/reference/connection-string/">MongoDB Connection String</a>.
This feature is provided by the SDA Spring Boot Commons testing module and is only activated when
Flapdoodle's autoconfiguration is available for the test setup.</p>
<p>Clean up of the collections is important, especially when using a provided database, that may be
reused in a subsequent build.</p>
<p>To ensure backwards compatibility of the database after upgrades, refactorings or changing the
database framework, asserting with a bare <code>MongoClient</code> removes influence of mappers and converters.</p>
<details class="example">
<summary>Testing a MongoDB Repository</summary>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import static</span><span class="w"> </span><span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.mongodb.client.MongoClient</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.mongodb.client.MongoDatabase</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.ZonedDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.bson.Document</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.AfterEach</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.BeforeEach</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.mongodb.test.TestEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.sdase.commons.spring.boot.mongodb.test.TestEntityRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.autoconfigure.mongo.MongoConnectionDetails</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest.WebEnvironment</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span><span class="p">(</span><span class="n">classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MongoTestApp</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">webEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WebEnvironment</span><span class="p">.</span><span class="na">MOCK</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">TestEntityRepositoryTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nd">@Autowired</span><span class="w"> </span><span class="n">MongoClient</span><span class="w"> </span><span class="n">mongoClient</span><span class="p">;</span>
<span class="w">  </span><span class="nd">@Autowired</span><span class="w"> </span><span class="n">MongoConnectionDetails</span><span class="w"> </span><span class="n">mongoConnectionDetails</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@Autowired</span><span class="w"> </span><span class="n">TestEntityRepository</span><span class="w"> </span><span class="n">testEntityRepository</span><span class="p">;</span>

<span class="w">  </span><span class="nd">@AfterEach</span>
<span class="w">  </span><span class="nd">@BeforeEach</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">cleanDatabase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">getDb</span><span class="p">().</span><span class="na">getCollection</span><span class="p">(</span><span class="s">&quot;testEntity&quot;</span><span class="p">).</span><span class="na">drop</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldSaveToDatabase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">testEntityRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">TestEntity</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="s">&quot;id_1&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">setUniqueKey</span><span class="p">(</span><span class="s">&quot;unique-1&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">setZonedDateTime</span><span class="p">(</span><span class="n">ZonedDateTime</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&quot;2021-02-21T17:22:53+01:00[Europe/Paris]&quot;</span><span class="p">)));</span>

<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">getDb</span><span class="p">().</span><span class="na">getCollection</span><span class="p">(</span><span class="s">&quot;testEntity&quot;</span><span class="p">).</span><span class="na">countDocuments</span><span class="p">()).</span><span class="na">isOne</span><span class="p">();</span>
<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">getDb</span><span class="p">().</span><span class="na">getCollection</span><span class="p">(</span><span class="s">&quot;testEntity&quot;</span><span class="p">).</span><span class="na">find</span><span class="p">().</span><span class="na">first</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">isEqualTo</span><span class="p">(</span>
<span class="w">            </span><span class="n">Document</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                {</span>
<span class="s">                  &quot;_class&quot;: &quot;org.sdase.commons.spring.boot.mongodb.test.TestEntity&quot;,</span>
<span class="s">                  &quot;_id&quot;: &quot;id_1&quot;,</span>
<span class="s">                  &quot;uniqueKey&quot;: &quot;unique-1&quot;,</span>
<span class="s">                  &quot;zonedDateTime&quot;: {&quot;$date&quot;: &quot;2021-02-21T16:22:53Z&quot;}</span>
<span class="s">                }</span>
<span class="s">                &quot;&quot;&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldFindInDatabase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">getDb</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">getCollection</span><span class="p">(</span><span class="s">&quot;testEntity&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">insertOne</span><span class="p">(</span>
<span class="w">            </span><span class="n">Document</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                {</span>
<span class="s">                  &quot;_class&quot;: &quot;org.sdase.commons.spring.boot.mongodb.test.TestEntity&quot;,</span>
<span class="s">                  &quot;_id&quot;: &quot;id_2&quot;,</span>
<span class="s">                  &quot;uniqueKey&quot;: &quot;unique-2&quot;,</span>
<span class="s">                  &quot;zonedDateTime&quot;: {&quot;$date&quot;: &quot;2021-02-21T17:21:53Z&quot;}</span>
<span class="s">                }</span>
<span class="s">                &quot;&quot;&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">TestEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">testEntityRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="s">&quot;id_2&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">get</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">extracting</span><span class="p">(</span><span class="n">TestEntity</span><span class="p">::</span><span class="n">getId</span><span class="p">,</span><span class="w"> </span><span class="n">TestEntity</span><span class="p">::</span><span class="n">getUniqueKey</span><span class="p">,</span><span class="w"> </span><span class="n">TestEntity</span><span class="p">::</span><span class="n">getZonedDateTime</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">containsExactly</span><span class="p">(</span><span class="s">&quot;id_2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unique-2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ZonedDateTime</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&quot;2021-02-21T17:21:53Z&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Test</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldSaveAndFindInDatabase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">testEntityRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">TestEntity</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="s">&quot;id_3&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">setUniqueKey</span><span class="p">(</span><span class="s">&quot;unique-3&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">setZonedDateTime</span><span class="p">(</span><span class="n">ZonedDateTime</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&quot;2021-02-21T17:22:53+01:00[Europe/Paris]&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">TestEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">testEntityRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="s">&quot;id_3&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">get</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">extracting</span><span class="p">(</span><span class="n">TestEntity</span><span class="p">::</span><span class="n">getId</span><span class="p">,</span><span class="w"> </span><span class="n">TestEntity</span><span class="p">::</span><span class="n">getUniqueKey</span><span class="p">,</span><span class="w"> </span><span class="n">TestEntity</span><span class="p">::</span><span class="n">getZonedDateTime</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">containsExactly</span><span class="p">(</span><span class="s">&quot;id_3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unique-3&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ZonedDateTime</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&quot;2021-02-21T16:22:53Z&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">MongoDatabase</span><span class="w"> </span><span class="nf">getDb</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">mongoClient</span><span class="p">.</span><span class="na">getDatabase</span><span class="p">(</span><span class="n">mongoConnectionDetails</span><span class="p">.</span><span class="na">getConnectionString</span><span class="p">().</span><span class="na">getDatabase</span><span class="p">());</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../metadata-context/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Metadata Context">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Metadata Context
              </div>
            </div>
          </a>
        
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.footer", "content.action.edit"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8d2eff1.min.js"></script>
      
        <script src="../search/main.js"></script>
      
    
  </body>
</html>