
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../starter-mongodb/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Starter Web - sda-spring-boot-commons</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#starter-web" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="sda-spring-boot-commons" class="md-header__button md-logo" aria-label="sda-spring-boot-commons" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            sda-spring-boot-commons
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Starter Web
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="sda-spring-boot-commons" class="md-nav__button md-logo" aria-label="sda-spring-boot-commons" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    sda-spring-boot-commons
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Starter Web
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Starter Web
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authentication
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authorization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authorization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Authorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPA
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        Http Client
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Http Client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication-forwarding" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authentication forwarding
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trace-token" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trace-Token
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oidc-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        OIDC Client
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax-rs-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        JAX-RS Mapping
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#platform-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        Platform Client
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencing-in-openapi" class="md-nav__link">
    <span class="md-ellipsis">
      
        Referencing in OpenAPI
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throwing-apiexception" class="md-nav__link">
    <span class="md-ellipsis">
      
        Throwing ApiException
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actuator-endpoints-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Actuator endpoints (Tasks)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Actuator endpoints (Tasks)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementing-custom-actuator-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementing custom actuator endpoints
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jackson" class="md-nav__link">
    <span class="md-ellipsis">
      
        Jackson
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sda-specific-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        SDA specific metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jvm-and-system-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        JVM and System metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-metrics-for-monitoring-kafka" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Metrics for monitoring Kafka
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        MongoDB metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tracing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracing
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#health-checks-actuator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Health Checks / Actuator
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#correlation-of-logs-in-distributed-systems" class="md-nav__link">
    <span class="md-ellipsis">
      
        Correlation of Logs in Distributed Systems
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metadata-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metadata Context
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../starter-mongodb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Starter MongoDB
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../starter-kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Starter Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../starter-s3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Starter S3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Security Hardening
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../asyncapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AsyncAPI
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cloudevents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cloud Events
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../metadata-context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Metadata Context
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../web-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Migration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Migration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration-2-to-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migrate to v3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration-3-to-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migrate to v4
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration-4-to-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migrate to v5
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration-6-to-7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migrate to v7
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authentication
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authorization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authorization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Authorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa" class="md-nav__link">
    <span class="md-ellipsis">
      
        OPA
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        Http Client
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Http Client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication-forwarding" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authentication forwarding
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trace-token" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trace-Token
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oidc-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        OIDC Client
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax-rs-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        JAX-RS Mapping
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#platform-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        Platform Client
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencing-in-openapi" class="md-nav__link">
    <span class="md-ellipsis">
      
        Referencing in OpenAPI
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throwing-apiexception" class="md-nav__link">
    <span class="md-ellipsis">
      
        Throwing ApiException
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actuator-endpoints-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Actuator endpoints (Tasks)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Actuator endpoints (Tasks)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementing-custom-actuator-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementing custom actuator endpoints
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jackson" class="md-nav__link">
    <span class="md-ellipsis">
      
        Jackson
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sda-specific-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        SDA specific metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jvm-and-system-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        JVM and System metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-metrics-for-monitoring-kafka" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Metrics for monitoring Kafka
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        MongoDB metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tracing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracing
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#health-checks-actuator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Health Checks / Actuator
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#correlation-of-logs-in-distributed-systems" class="md-nav__link">
    <span class="md-ellipsis">
      
        Correlation of Logs in Distributed Systems
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metadata-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metadata Context
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="starter-web">Starter Web<a class="headerlink" href="#starter-web" title="Permanent link">&para;</a></h1>
<p>The module <code>sda-commons-starter-web</code> provides several features to create a service based on the SDA
core concepts.</p>
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Description</th>
<th>Default</th>
<th>Example</th>
<th>Env</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.issuers</code> <em>string</em></td>
<td>Comma separated string of open id discovery key sources with required issuers.</td>
<td></td>
<td><code>https://iam-int.dev.de/auth/realms/123</code></td>
<td><code>AUTH_ISSUERS</code></td>
</tr>
<tr>
<td><code>auth.disable</code> <em>boolean</em></td>
<td>Disables authorization checks completely.</td>
<td><code>false</code></td>
<td><code>true</code></td>
<td><code>AUTH_DISABLE</code></td>
</tr>
<tr>
<td><code>opa.disable</code> <em>boolean</em></td>
<td>Disables authorization checks with Open Policy Agent completely. In this case access to all resources is granted but no constraints are provided.</td>
<td><code>false</code></td>
<td><code>true</code></td>
<td><code>OPA_DISABLE</code></td>
</tr>
<tr>
<td><code>opa.base.url</code> <em>string</em></td>
<td>The baseUrl of the Open Policy Agent Server.</td>
<td><code>"http://localhost:8181"</code></td>
<td><code>"http://opa-service:8181"</code></td>
<td><code>OPA_BASE_URL</code></td>
</tr>
<tr>
<td><code>opa.policy.package</code> <em>string</em></td>
<td>The policy package to check for authorization. The policy must return the property <code>allow</code> as <em>boolean</em> as access decision and may return additional properties as constraints.</td>
<td>the package of the application class, be aware that moving the class causes a breaking change regarding deployment if the package is not explicitly set.</td>
<td><code>"com.custom.package.name"</code></td>
<td><code>OPA_POLICY_PACKAGE</code></td>
</tr>
<tr>
<td><code>opa.exclude.patterns</code> <em>string</em></td>
<td>Custom excluded paths can be configured as comma separated list of regex.</td>
<td><code>openapi.json</code> and <code>openapi.yaml</code></td>
<td><code>"/customPathOne,/customPathTwo"</code></td>
<td><code>OPA_EXCLUDE_PATTERNS</code></td>
</tr>
<tr>
<td><code>opa.client.connection.timeout</code> <em>string</em></td>
<td>The connection timeout of the client that calls the Open Policy Agent server.</td>
<td><code>"500ms"</code></td>
<td><code>"2s"</code></td>
<td><code>OPA_CLIENT_CONNECTION_TIMEOUT</code></td>
</tr>
<tr>
<td><code>opa.client.timeout</code> <em>string</em></td>
<td>The read timeout of the client that calls the Open Policy Agent server.</td>
<td><code>"500ms"</code></td>
<td><code>"2s"</code></td>
<td><code>OPA_CLIENT_TIMEOUT</code></td>
</tr>
<tr>
<td><code>oidc.client.enabled</code> <em>boolean</em></td>
<td>Enables OIDC Authentication (Client Credentials Flow) for the configured clients.</td>
<td><code>false</code></td>
<td><code>true</code></td>
<td><code>OIDC_CLIENT_ENABLED</code></td>
</tr>
<tr>
<td><code>oidc.client.id</code> <em>string</em></td>
<td>The client ID for the registration.</td>
<td></td>
<td><code>"exampleClient"</code></td>
<td><code>OPA_CLIENT_ID</code></td>
</tr>
<tr>
<td><code>oidc.client.secret</code> <em>string</em></td>
<td>The Client secret of the registration.</td>
<td></td>
<td><code>"s3cret"</code></td>
<td><code>OIDC_CLIENT_SECRET</code></td>
</tr>
<tr>
<td><code>oidc.client.issuer.uri</code> <em>string</em></td>
<td>URI that can either be an OpenID Connect discovery endpoint or an OAuth 2.0 Authorization Server Metadata endpoint defined by RFC 8414.</td>
<td></td>
<td><code>"https://keycloak.sdadev.sda-se.io/auth/realms/exampleRealm"</code></td>
<td><code>OIDC_CLIENT_ISSUER_URI</code></td>
</tr>
<tr>
<td><code>oidc.client.authentication-passthrough.enabled</code> <em>string</em></td>
<td>Flag indicating whether the token from the existing request context should be used, if exists, before attempting to generate new one</td>
<td><code>true</code></td>
<td><code>false</code></td>
<td><code>OIDC_CLIENT_AUTHENTICATION_PASSTHROUGH_ENABLED</code></td>
</tr>
<tr>
<td><code>cors.allowed-origin-patterns</code> <em>string</em></td>
<td>Comma separated list of URL patterns for which CORS requests are allowed.</td>
<td><em>none allowed</em></td>
<td><code>"https://*.all-subdomains.com, https://static-domain.com"</code></td>
<td><code>CORS_ALLOWEDORIGINPATTERNS</code></td>
</tr>
<tr>
<td><code>enable.json.logging</code> <em>boolean</em></td>
<td>If logs should be printed as JSON. <em>Note: This config param is not available for application.properties or application.yaml</em></td>
<td><em>false</em></td>
<td><code>true</code></td>
<td><code>ENABLE_JSON_LOGGING</code></td>
</tr>
<tr>
<td><code>management.opentelemetry.tracing.export.otlp.endpoint</code> <em>string</em></td>
<td>Base url to OTLP Collector instance. It applies for http or gRPC, if enabled</td>
<td><code>http://grafana-agent-traces.monitoring:4317</code></td>
<td><code>"http://localhost:4318"</code></td>
<td><code>MANAGEMENT_OPENTELEMETRY_TRACING_EXPORT_OTLP_ENDPOINT</code></td>
</tr>
<tr>
<td><code>management.tracing.export.enabled</code> <em>boolean</em></td>
<td>If tracing should be unit-tested, it is important to have the annotation <code>@AutoConfigureTracing</code>  on your test class to enable tracing.</td>
<td><code>true</code> (<code>false</code> in test contexts)</td>
<td><code>false</code></td>
<td><code>MANAGEMENT_TRACING_EXPORT_ENABLED</code></td>
</tr>
<tr>
<td><code>management.tracing.sampling.probability</code> <em>number</em></td>
<td>Probability in the range from 0.0 to 1.0 that a trace will be sampled.</td>
<td><code>1.0</code></td>
<td><code>0.2</code></td>
<td><code>MANAGEMENT_TRACING_SAMPLING_PROBABILITY</code></td>
</tr>
<tr>
<td><code>management.tracing.propagation.type</code> <em>string</em></td>
<td>Tracing context propagation types produced and consumed by the application. Setting this property overrides the more fine-grained propagation type properties.</td>
<td><code>"b3,w3c"</code></td>
<td><code>"b3"</code></td>
<td><code>MANAGEMENT_TRACING_PROPAGATION_TYPE</code></td>
</tr>
<tr>
<td><code>management.tracing.grpc.enabled</code> <em>boolean</em></td>
<td>You only need to set this property to true if you want to use grpc (port 4317) vs http (port 4318) channel for span export.</td>
<td><code>true</code></td>
<td><code>false</code></td>
<td><code>MANAGEMENT_TRACING_GRPC_ENABLED</code></td>
</tr>
<tr>
<td><code>management.opentelemetry.tracing.export.otlp.compression</code> <em>string</em></td>
<td>Method used to compress the payload. Options: "gzip", "none"</td>
<td><code>"none"</code></td>
<td><code>"gzip"</code></td>
<td><code>MANAGEMENT_OPENTELEMETRY_TRACING_EXPORT_OTLP_COMPRESSION</code></td>
</tr>
<tr>
<td><code>management.opentelemetry.tracing.export.otlp.timeout</code> <em>string</em></td>
<td>Call timeout for the OTel Collector to process an exported batch of data. This timeout spans the entire call.</td>
<td><code>"10s"</code></td>
<td><code>"20s"</code></td>
<td><code>MANAGEMENT_OPENTELEMETRY_TRACING_EXPORT_OTLP_TIMEOUT</code></td>
</tr>
<tr>
<td><code>spring.application.name</code> <em>string</em></td>
<td>The application name, also used for tracing. For PR deployments, you need to make sure it will have the PR suffix to distinguish tracings.</td>
<td><code>"application"</code></td>
<td><code>"my-service-name"</code></td>
<td><code>SPRING_APPLICATION_NAME</code></td>
</tr>
<tr>
<td><em>only as environment variable</em></td>
<td>Field names as comma separated String in communication (e.g. HTTP headers), that are included in the metadata context of a process.</td>
<td></td>
<td><code>"ab-variant,landing-page"</code></td>
<td><code>METADATA_FIELDS</code></td>
</tr>
<tr>
<td><code>security.validation-exception-handler-enabled</code></td>
<td>Allow to turn off ValidationExceptionHandler which is handling http status of responses when validation fails. defaults to true if omitted.</td>
<td><code>true</code></td>
<td><code>false</code></td>
<td><code>SECURITY_VALIDATION_EXCEPTION_HANDLER_ENABLED</code></td>
</tr>
</tbody>
</table>
<p>For further information have a look at the <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#documentation">Spring Boot documentation</a>.</p>
<details class="info">
<summary>Default configuration set by this library</summary>
<div class="language-properties highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">server.servlet.context-path</span><span class="o">=</span><span class="s">/api</span>
<span class="na">server.port</span><span class="o">=</span><span class="s">8080</span>
<span class="na">server.max-http-request-header-size</span><span class="o">=</span><span class="s">8192</span>
<span class="na">spring.web.error.whitelabel.enabled</span><span class="o">=</span><span class="s">false</span>

<span class="na">server.tomcat.basedir</span><span class="o">=</span><span class="s">${java.io.tmpdir}/tomcat</span>


<span class="c1"># Actuator</span>
<span class="na">management.server.port</span><span class="o">=</span><span class="s">8081</span>
<span class="na">management.server.base-path</span><span class="o">=</span><span class="s">/</span>
<span class="na">management.endpoints.web.base-path</span><span class="o">=</span><span class="s">/</span>
<span class="na">management.endpoints.web.exposure.include</span><span class="o">=</span><span class="s">*</span>
<span class="na">management.endpoints.access.default</span><span class="o">=</span><span class="s">none</span>
<span class="c1"># Healthcheck</span>
<span class="na">management.endpoint.health.access</span><span class="o">=</span><span class="s">read-only</span>
<span class="na">management.endpoints.web.path-mapping.health</span><span class="o">=</span><span class="s">healthcheck</span>
<span class="na">management.endpoint.health.probes.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="c1"># Add the required auto-configured health indicators which are supported in org.sdase.commons.spring</span>
<span class="c1"># See https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.health.auto-configured-health-indicators</span>
<span class="c1"># to see the available indicators. If an included HealthIndicator is not autoconfigured, it will be automatically ignored (see management.endpoint.health.validate-group-membership)</span>
<span class="na">management.endpoint.health.group.readiness.include</span><span class="o">=</span><span class="s">readinessState, mongo, openPolicyAgent, kafka</span>
<span class="c1"># since 3.1.0, configured health checks must exist,</span>
<span class="c1"># see https://github.com/spring-projects/spring-boot/commit/c55d398f95bf1c64a55ea95e1dc8ae20e9ce7561#diff-ecf768cadbb11cdb6a8999f942301ff33662b2b00221188613ab3c4402e1200a</span>
<span class="na">management.endpoint.health.validate-group-membership</span><span class="o">=</span><span class="s">false</span>
<span class="na">management.endpoint.health.show-details</span><span class="o">=</span><span class="s">always</span>
<span class="na">management.endpoint.health.show-components</span><span class="o">=</span><span class="s">always</span>
<span class="c1"># Metrics</span>
<span class="na">management.endpoints.web.path-mapping.prometheus</span><span class="o">=</span><span class="s">metrics/prometheus</span>
<span class="na">management.endpoint.prometheus.access</span><span class="o">=</span><span class="s">read-only</span>
<span class="na">management.endpoint.metrics.access</span><span class="o">=</span><span class="s">read-only</span>
<span class="na">management.endpoint.availableEndpoints.access</span><span class="o">=</span><span class="s">read-only</span>


<span class="na">management.tracing.export.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="na">management.tracing.propagation.type</span><span class="o">=</span><span class="s">b3,w3c</span>
<span class="na">management.tracing.sampling.probability</span><span class="o">=</span><span class="s">1.0</span>
<span class="na">management.opentelemetry.tracing.export.otlp.endpoint</span><span class="o">=</span><span class="s">http://grafana-agent-traces.monitoring:4317</span>
<span class="na">management.opentelemetry.tracing.export.otlp.compression</span><span class="o">=</span><span class="s">none</span>
<span class="na">management.opentelemetry.tracing.export.otlp.timeout</span><span class="o">=</span><span class="s">10s</span>
<span class="na">management.tracing.grpc.enabled</span><span class="o">=</span><span class="s">true</span>


<span class="na">feign.metrics.enabled</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
</details>
<p><strong>Please make sure to configure <code>spring.application.name</code> for every service.</strong></p>
<h2 id="authentication">Authentication<a class="headerlink" href="#authentication" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#web.security">Spring Security Documentation</a></li>
</ul>
<p>Enables feature that make a Spring Boot service compliant with the SDA SE Authentication concepts
using OIDC.</p>
<p>OIDC Authentication can be configured with <code>auth.issuers</code> to provide a comma separated
list of trusted issuers. In develop and test environments, the boolean <code>auth.disable</code> may
be used to disable authentication.</p>
<p>The JWKS URI of each issuer is updated when an unknown Key ID is received and every 5 minutes. The
cache of known JWK is invalidated after 15 minutes.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This setup allows authenticated and anonymous requests! It is the responsibility of policies
provided by the Open Policy Agent to decide about denying anonymous requests.</p>
</div>
<p>Spring Security is disabled for the Management/Admin Port (default: 8081). Be aware that these port
should not be accessible out of the deployment context.</p>
<p>This security implementation lacks some features compared to <a href="https://github.com/SDA-SE/sda-dropwizard-commons/tree/main/sda-commons-server-auth">sda-dropwizard-commons</a>:
- No configuration of static local public keys to verify the token signature. 
- No configuration of JWKS URIs to verify the token signature. 
- The IDP must provide an <code>iss</code> claim that matches the base URI for discovery. 
- Clock skew is fixed to 60 seconds. 
- The client that loads the JWKS is not configurable yet.</p>
<h2 id="authorization">Authorization<a class="headerlink" href="#authorization" title="Permanent link">&para;</a></h2>
<p>Enables feature that make a Spring Boot service compliant with the SDA SE Authorization concepts
using Open Policy Agent.</p>
<p>The authorization is done by the <a href="https://www.openpolicyagent.org/">Open Policy Agent</a>. It can be 
configured with <a href="#configuration"><code>opa.</code> configuration properties</a>.</p>
<details class="info">
<summary>Requests to the Open Policy Agent</summary>
<p>Requests to the server are determined by the base URL and the policy package.
Given the default base URL <code>http://localhost:8181</code> and an example package of <code>com.my.service</code>,
the Open Policy Agent server will be requested for authorization decision at
<code>http://localhost:8181/v1/data/com/my/service</code>.</p>
</details>
<p>The OPA configuration acts as a client to the Open Policy Agent and is hooked in as request filter
which is part of the <code>SecurityFilterChain</code> including the OIDC Authentication.</p>
<p>Constraints provided with the Open Policy Agent response can be mapped to a custom POJO.
The class must extend <code>org.sdase.commons.spring.boot.web.auth.opa.AbstractConstraints</code> and must be
annotated with <code>org.sdase.commons.spring.boot.web.auth.opa.Constraints</code>.
It has request scope and can be <a href="https://javadoc.io/doc/org.springframework/spring-beans/latest/org/springframework/beans/factory/annotation/Autowired.html"><code>@Autowired</code></a> 
in <a href="https://javadoc.io/doc/org.springframework/spring-webmvc/latest/org/springframework/web/servlet/mvc/Controller.html"><code>@Controllers</code></a> 
or <a href="https://javadoc.io/doc/org.springframework/spring-web/latest/org/springframework/web/bind/annotation/RestController.html"><code>@RestControllers</code></a>.</p>
<details class="example">
<summary>Custom Constraint implementation</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">com.example.my.service.rego</label><label for="__tabbed_1_2">MyConstraints.java</label><label for="__tabbed_1_3">MyController.java</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">my</span><span class="o">.</span><span class="n">service</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">input</span>

<span class="c1"># decode the token</span>
<span class="n">token</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span> <span class="p">{</span>
  <span class="ow">not</span> <span class="nb">input</span><span class="o">.</span><span class="n">jwt</span> <span class="o">=</span> <span class="n">null</span>
  <span class="n">io</span><span class="o">.</span><span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">jwt</span><span class="p">,</span> <span class="p">[</span><span class="n">_</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">_</span><span class="p">])</span>
<span class="p">}</span>

<span class="c1"># deny by default!</span>
<span class="n">default</span> <span class="n">allow</span> <span class="o">=</span> <span class="n">false</span>

<span class="n">allow</span> <span class="p">{</span>
  <span class="c1"># your rules</span>
<span class="p">}</span>

<span class="n">admin</span> <span class="p">{</span>
  <span class="n">token</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">admin</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Constraints</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyConstraints</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractConstraints</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">MyConstraints</span><span class="w"> </span><span class="nf">setAdmin</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">admin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAdmin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@RestController</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MyConstraints</span><span class="w"> </span><span class="n">myConstraints</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</details>
<p>Additional parameters that are needed for the authorization decision may be provided with custom
<code>org.sdase.commons.spring.boot.web.auth.opa.extension.OpaInputExtension</code>s.</p>
<h3 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h3>
<p>The <a href="../web-testing/#authentication-and-authorization">testing module</a> provides aligned test
dependencies including Wiremock for external APIs and JUnit extensions to mock or disable
authentication and authorization.</p>
<h3 id="opa">OPA<a class="headerlink" href="#opa" title="Permanent link">&para;</a></h3>
<p><img alt="Overview" src="../assets/overview_opa.svg" /></p>
<p>The OPA configuration requests the policy decision providing the following inputs</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>input.httpMethod</code></td>
<td>HTTP method as uppercase string.</td>
<td><code>"GET"</code></td>
</tr>
<tr>
<td><code>input.path</code></td>
<td>Requested path as array of path segments without context or servlet path.</td>
<td><code>["myResource", "123-id", "someSubresource"]</code></td>
</tr>
<tr>
<td><code>input.jwt</code></td>
<td>Validated encoded JWT as string (if available).</td>
<td><code>"eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIn0.Xpk63zUfXiI5f_bdGjqrhx03aGyBn9ETgXbkAgLalPk"</code></td>
</tr>
<tr>
<td><code>input.headers</code></td>
<td>All HTTP request headers as object with lower-case header names as key and array of headers as value.</td>
<td><code>{"accept": "text/plain", "accept": "application/json"}</code></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Security note</p>
<p>While a service might only consider one value of a specific header, that a policy might
authorize on an array of those or vice versa.
Consider this in your policy when you want to make sure you authorize on the same value that a
service might use to evaluate the output.</p>
</div>
<details class="info">
<summary>Remark to HTTP request headers</summary>
<p>The configuration normalizes header names to lower case to simplify handling in OPA since HTTP
specification defines header names as case-insensitive.
Multivalued headers are not normalized with respect to the representation as list or single string
with separator char.
They are forwarded as parsed by the framework.</p>
</details>
<details class="example">
<summary>Example Policy Using Input</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Policy</label><label for="__tabbed_2_2">Result</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># each policy lies in a package that is referenced in the configuration of the OpaBundle</span>
<span class="n">package</span> <span class="n">example</span>

<span class="c1"># decode the JWT as new variable &#39;token&#39;</span>
<span class="n">token</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span> <span class="p">{</span>
    <span class="ow">not</span> <span class="nb">input</span><span class="o">.</span><span class="n">jwt</span> <span class="o">==</span> <span class="n">null</span>
    <span class="n">io</span><span class="o">.</span><span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">jwt</span><span class="p">,</span> <span class="p">[</span><span class="n">_</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">_</span><span class="p">])</span>
<span class="p">}</span>

<span class="c1"># deny by default</span>
<span class="n">default</span> <span class="n">allow</span> <span class="o">=</span> <span class="n">false</span>

<span class="c1"># the allow property is required for authorization</span>
<span class="n">allow</span> <span class="p">{</span>
    <span class="c1"># allow if path match &#39;/contracts/:anyid&#39; </span>
    <span class="nb">input</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;contracts&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span>

    <span class="c1"># allow if request method &#39;GET&#39; is used</span>
    <span class="nb">input</span><span class="o">.</span><span class="n">httpMethod</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span>

    <span class="c1"># allow if &#39;claim&#39; exists in the JWT payload</span>
    <span class="n">token</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">claim</span>

    <span class="c1"># allow if a request header &#39;HttpRequestHeaderName&#39; has a certain value </span>
    <span class="nb">input</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;httprequestheadername&quot;</span><span class="p">][</span><span class="n">_</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;certain-value&quot;</span>
<span class="p">}</span>

<span class="c1"># set some example constraints</span>
<span class="c1"># constraints are always service dependent and the structure, if any, is defined in each service</span>
<span class="n">constraint1</span> <span class="o">:=</span> <span class="n">true</span>                <span class="c1"># always true</span>
<span class="n">constraint2</span> <span class="o">:=</span> <span class="p">[</span> <span class="s2">&quot;v2.1&quot;</span><span class="p">,</span> <span class="s2">&quot;v2.2&quot;</span> <span class="p">]</span>  <span class="c1"># always an array of &quot;v2.1&quot; and &quot;v2.2&quot;</span>
<span class="n">constraint3</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sub</span><span class="p">]</span>     <span class="c1"># always a set that contains the &#39;sub&#39; claim from the token</span>
                                   <span class="c1"># or is empty if no token is present</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;allow&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;constraint1&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;constraint2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;v2.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;v2.2&quot;</span><span class="w"> </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;constraint3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;my-sub&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</details>
<h2 id="http-client">Http Client<a class="headerlink" href="#http-client" title="Permanent link">&para;</a></h2>
<p>Enables support for <a href="https://javadoc.io/doc/org.springframework.cloud/spring-cloud-openfeign-core/3.1.6/index.html"><code>org.springframework.cloud.openfeign.FeignClients</code></a> 
that support SDA Platform features like:</p>
<p>- passing the Authorization header to downstream services.
  - passing the Trace-Token header to downstream services.
  - OIDC client authentication</p>
<p>A feign client can be created as interface like this:
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@FeignClient</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;partnerOds&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${partnerOds.baseUrl}&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">OtherServiceClient</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/partners&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Partner</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPartners</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
Then the spring boot application needs to be annotated with <code>@EnableFeignClients</code> in order for the component 
scanning to pick up the <code>@FeignClient</code> annotated interfaces like so
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@EnableFeignClients</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ExampleApplication</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(...)</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<p>The Partner ODS base url must be configured as <code>http://partner-ods:8080/api</code> in the Spring
environment property <code>partnerOds.baseUrl</code>. Detailed configuration like timeouts can be configured
with <a href="https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/#spring-cloud-feign-overriding-defaults">default feign properties</a> 
in the <code>application.yaml</code> or <code>derived environment</code> properties based on the <code>name</code> attribute of the 
<a href="https://javadoc.io/doc/org.springframework.cloud/spring-cloud-openfeign-core/3.1.6/index.html"><code>org.springframework.cloud.openfeign.FeignClient</code></a> 
annotation.</p>
<p>The client is then available as bean in the Spring context.</p>
<h3 id="authentication-forwarding">Authentication forwarding<a class="headerlink" href="#authentication-forwarding" title="Permanent link">&para;</a></h3>
<p>The client can be used within the SDA Platform to path through the received authentication header by
adding a configuration:
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@FeignClient</span><span class="p">(</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;partnerOds&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${partnerOds.baseUrl}&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">AuthenticationPassThroughClientConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">}</span>
<span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">OtherServiceClient</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/partners&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Partner</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPartners</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<p><code>org.sdase.commons.spring.boot.web.client.AuthenticationPassThroughClientConfiguration</code> will take
the <strong>Authorization</strong> header from the current request context of the servlet and adds its value to
the client request.</p>
<h3 id="trace-token">Trace-Token<a class="headerlink" href="#trace-token" title="Permanent link">&para;</a></h3>
<p>The client can be used within the SDA Platform to pass through the received <code>Trace-Token</code> header by adding a configuration:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@FeignClient</span><span class="p">(</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;partnerOds&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${partnerOds.baseUrl}&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">SdaTraceTokenClientConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">}</span>
<span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">OtherServiceClient</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/partners&quot;</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Partner</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPartners</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><code>org.sdase.commons.spring.boot.web.tracing.SdaTraceTokenClientConfiguration</code> will take the
<code>Trace-Token</code> header from the current request context of the servlet and adds its value to the
client request.</p>
<p>If no <code>Trace-Token</code> header is present in the current request context, the
<code>SdaTraceTokenClientConfiguration</code> will generate a new Trace-Token and pass it to the following
requests.</p>
<h3 id="oidc-client">OIDC Client<a class="headerlink" href="#oidc-client" title="Permanent link">&para;</a></h3>
<p>If the request context is not always existing, e.g. in cases where a technical user for
service-to-service communication is required, the
<code>.org.sdase.commons.spring.boot.web.client.OidcClientRequestConfiguration</code> will request the required
OIDC authentication token with the client credentials flow using the configured
<code>"oidc.client.issuer.uri"</code>, <code>"oidc.client.id"</code> and <code>"oidc.client.secret"</code>.</p>
<p>If the current request context contains the <strong>Authorization</strong> header, the authentication
pass-through will be applied instead, in case <code>"oidc.client.authentication-passthrough.enabled"</code> flag is enabled.</p>
<h3 id="jax-rs-mapping">JAX-RS Mapping<a class="headerlink" href="#jax-rs-mapping" title="Permanent link">&para;</a></h3>
<p>If you would like to use JAX-RS based web annotations, you just need to apply
the <code>feign.jaxrs.JakartaContract.class</code> to configurations.</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;customers&quot;</span><span class="p">)</span>
<span class="nd">@FeignClient</span><span class="p">(</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;customerService&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${customer.api.base.url}&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">OidcClientRequestConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">feign</span><span class="p">.</span><span class="na">jaxrs</span><span class="p">.</span><span class="na">JakartaContract</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CustomerServiceApi</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nd">@POST</span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/{customerId}/contracts&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">addContract</span><span class="p">(</span>
<span class="w">      </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&quot;customerId&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@NotBlank</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">customerId</span><span class="p">,</span>
<span class="w">      </span><span class="n">Contract</span><span class="w"> </span><span class="n">contract</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="platform-client">Platform Client<a class="headerlink" href="#platform-client" title="Permanent link">&para;</a></h3>
<p>The <code>PlatformClient</code> combines the authentication forwarding, trace token and OIDC configuration
without the need to configure each individually.</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@PlatformClient</span><span class="p">(</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;customerService&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${customer.api.base.url}&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CustomerServiceApi</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>It abstracts some configuration of the FeignClient and is then available as bean as well.</p>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<p>The module <code>sda-commons-starter-web</code> provides a shared <code>ApiError</code> model, to provide a common
response error structure for SDA-restful services.</p>
<h3 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h3>
<p>Per default, the module <code>sda-commons-starter-web</code> autoconfigures a
global <code>@ExceptionHandler(ApiException.class)</code> as <code>@ControllerAdvice</code>. As a result, the
exception handler is per default provided to every <code>@Controller</code>.</p>
<h4 id="referencing-in-openapi">Referencing in OpenAPI<a class="headerlink" href="#referencing-in-openapi" title="Permanent link">&para;</a></h4>
<p>To provide the common <code>ApiError</code> in the API, you need to reference the class as <code>@Schema</code>.</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>@ApiResponse(
    responseCode = &quot;422&quot;,
    description =
        &quot;The request could not be processed due to invalid parameters. Details are provided in the error response.&quot;,
    content = @Content(schema = @Schema(implementation = ApiError.class)))
</code></pre></div></td></tr></table></div>
<h4 id="throwing-apiexception">Throwing ApiException<a class="headerlink" href="#throwing-apiexception" title="Permanent link">&para;</a></h4>
<p>When the <code>ApiException</code> is thrown the <code>@ExceptionHandler</code> automatically intercepts the exception and
maps the related <code>ResponseEntity</code>. As the result, the controller returns the related http response
code and the nested <code>ApiError</code>.</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>    throw ApiException.builder()
      .httpCode(422)
      .title(&quot;Invalid input&quot;)
      .detail(&quot;name&quot;, &quot;name was not null&quot;, &quot;NOT_NULL&quot;)
      .cause(e)
      .build();
</code></pre></div></td></tr></table></div>
<p>In this example the controller would return with http status <code>422</code> and body:</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Invalid input&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;invalidParams&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;reason&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name was not null&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;errorCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NOT_NULL&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="actuator-endpoints-tasks">Actuator endpoints (Tasks)<a class="headerlink" href="#actuator-endpoints-tasks" title="Permanent link">&para;</a></h2>
<p>Similar to dropwizards tasks, spring-boot provides <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints">actuators</a> to expose endpoints on the management
port to monitor or interact with the application on an administrative level. The most basic example
for this is the <code>/health</code> endpoint which provides information about the status of the service.</p>
<h3 id="implementing-custom-actuator-endpoints">Implementing custom actuator endpoints<a class="headerlink" href="#implementing-custom-actuator-endpoints" title="Permanent link">&para;</a></h3>
<p>Custom actuator endpoints can be registered with with the <code>@Endpoint</code> annotation:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Endpoint</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="s">&quot;custom&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomActuatorEndpoint</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This will expose the endpoint under <code>http://{SERVICE}:{MANAGEMENT_PORT}/custom</code>, where the
id of the endpoint correlates with the path.</p>
<p><strong>NOTE:</strong>
The default path for actuator endpoints in spring-boot is <code>/actuator/</code>. However, in sda-spring-boot-commons
it is configured to just <code>/</code>. See configuration of <a href="https://github.com/SDA-SE/sda-spring-boot-commons/blob/2138dc57b33f954dd68c514f2e13957efa37b514/sda-commons-starter-web/src/main/resources/org/sdase/commons/spring/boot/web/monitoring/monitoring.properties#L4">management.endpoints.web.base-path</a></p>
<p><code>GET</code>, <code>POST</code> and <code>DELETE</code> methods can then be implemented with the according <code>@ReadOperation</code>, <code>@WriteOperation</code>
and <code>@DeleteOperation</code>:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="c1">// Responds to a GET request to /actuator/custom</span>
<span class="w">  </span><span class="nd">@ReadOperation</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">readSomeData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">someRepository</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Responds to a POST request to /actuator/custom</span>
<span class="w">  </span><span class="nd">@WriteOperation</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeSomeData</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">someRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// return HttpStatus.OK</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Responds to a DELETE request to /actuator/custom</span>
<span class="w">  </span><span class="nd">@DeleteOperation</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deleteSomeData</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">someRepository</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// return HttpStatus.OK</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Actuators can then be enabled or disabled through the application properties
<div class="language-yaml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">management.endpoint.custom.enabled=true</span>
</code></pre></div></td></tr></table></div></p>
<p>See the <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.implementing-custom">official spring-boot documentation</a> for further details.</p>
<h2 id="async">Async<a class="headerlink" href="#async" title="Permanent link">&para;</a></h2>
<p>The default Spring <a href="https://javadoc.io/doc/org.springframework/spring-context/latest/org/springframework/scheduling/annotation/Async.html">async</a> 
task executor is autoconfigured to transfer the request attributes of the 
current request to the <strong>Thread</strong> running the asynchronous method.</p>
<h2 id="jackson">Jackson<a class="headerlink" href="#jackson" title="Permanent link">&para;</a></h2>
<p>Enables feature that makes a Spring Boot service compliant with the REST guide of SDA SE.
So far this covers:
- the tolerant reader pattern
- consistent serialization of <code>java.time.ZonedDateTime</code> compatible to the <a href="https://json-schema.org/understanding-json-schema/reference/string.html#dates-and-times">type <code>date-time</code> of JSON-Schema</a>.
  It is strongly recommended to use
  - <code>java.time.LocalDate</code> for dates without time serialized as <code>2018-09-23</code>
  - <code>java.time.ZonedDateTime</code> for date and times serialized as <code>2018-09-23T14:21:41+01:00</code>
  - <code>java.time.Duration</code> for durations with time resolution serialized as <code>P1DT13M</code>
  - <code>java.time.Period</code> for durations with day resolution serialized as <code>P1Y2D</code></p>
<p>All these types can be read and written in JSON as ISO 8601 formats.
Reading <code>java.time.ZonedDateTime</code> is configured to be tolerant so that added nanoseconds or missing
milliseconds or missing seconds are supported.</p>
<p><code>@com.fasterxml.jackson.annotation.JsonFormat(pattern = "...")</code> should not be used for customizing
serialization because it breaks tolerant reading of formatting variants. If a specific field should
be serialized with milliseconds, it must be annotated with
<code>@com.fasterxml.jackson.databind.annotation.JsonSerialize(using = Iso8601Serializer.WithMillis.class)</code>
. If a specific field should be serialized with nanoseconds, it must be annotated with
<code>@com.fasterxml.jackson.databind.annotation.JsonSerialize(using = Iso8601Serializer.WithNanos.class)</code></p>
<p>The standard SDA <code>tools.jackson.databind.ObjectMapper</code> is configured as <code>tools.jackson.databind.json.JsonMapper</code>.</p>
<p><strong>Differences to the known <a href="https://github.com/SDA-SE/sda-dropwizard-commons/tree/main/sda-commons-server-jackson">SDA Dropwizard Commons configuration</a></strong>
- <code>java.time.ZonedDateTime</code> fields are serialized with seconds by default.
  There is no other global configuration for <strong>java.time.ZonedDateTime</strong> serialization available.
- <strong>Fewer modules are activated for foreign frameworks</strong>. Compared to SDA Dropwizard Commons,
  <strong>GuavaExtrasModule, JodaModule, and CaffeineModule</strong> are not registered anymore.
- Support for <strong>HAL Links and embedding linked resources</strong> is not implemented.
- Support for <strong>YAML</strong> is not implemented.
- There is <strong>no support for field filters</strong>.
  Such filters have been barely used in the SDA SE.</p>
<h2 id="monitoring">Monitoring<a class="headerlink" href="#monitoring" title="Permanent link">&para;</a></h2>
<p>Services use Prometheus to scrape and store metrics.</p>
<p>An actuator exposing metrics in prometheus format is available using the following endpoint</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>http://{serviceURL}:{adminPort}/metrics/prometheus
</code></pre></div></td></tr></table></div>
<p>Spring Boot is using <a href="https://micrometer.io/">micrometer</a> to instrument code using out-of-the-box bindings for common libraries.</p>
<h3 id="sda-specific-metrics">SDA specific metrics<a class="headerlink" href="#sda-specific-metrics" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Metric Name</th>
<th>Labels</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>healthcheck_status</code></td>
<td><code>name</code></td>
<td>Exposes healthcheck as metric for multiple indicators</td>
</tr>
</tbody>
</table>
<h3 id="jvm-and-system-metrics">JVM and System metrics<a class="headerlink" href="#jvm-and-system-metrics" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Metric Name</th>
<th>Labels</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jvm_classes_loaded_classes</code></td>
<td></td>
<td>The number of classes that are currently loaded in the Java virtual machine.</td>
</tr>
<tr>
<td><code>jvm_classes_unloaded_classes</code></td>
<td></td>
<td>The total number of classes unloaded since the Java virtual machine has started execution.</td>
</tr>
<tr>
<td><code>jvm_buffer_count_buffers</code></td>
<td><code>id</code></td>
<td>An estimate of the number of buffers in the pool.</td>
</tr>
<tr>
<td><code>jvm_buffer_memory_used_bytes</code></td>
<td><code>id</code></td>
<td>An estimate of the memory that the Java virtual machine is using for this buffer pool.</td>
</tr>
<tr>
<td><code>jvm_buffer_total_capacity_bytes</code></td>
<td><code>id</code></td>
<td>An estimate of the total capacity of the buffers in this pool.</td>
</tr>
<tr>
<td><code>jvm_memory_used_bytes</code></td>
<td><code>id</code>, <code>area</code></td>
<td>The amount of used memory.</td>
</tr>
<tr>
<td><code>jvm_memory_committed_bytes</code></td>
<td><code>id</code>, <code>area</code></td>
<td>The amount of memory in bytes that is committed for the Java virtual machine to use.</td>
</tr>
<tr>
<td><code>jvm_memory_max_bytes</code></td>
<td><code>id</code>, <code>area</code></td>
<td>The maximum amount of memory in bytes that can be used for memory management.</td>
</tr>
<tr>
<td><code>jvm_memory_usage_after_gc</code></td>
<td></td>
<td>The amount of memory used by the JVM after garbage collection (GC) has occurred.</td>
</tr>
<tr>
<td><code>jvm_gc_max_data_size_bytes</code></td>
<td></td>
<td>Max size of long-lived heap memory pool.</td>
</tr>
<tr>
<td><code>jvm_gc_live_data_size_bytes</code></td>
<td></td>
<td>Size of long-lived heap memory pool after reclamation.</td>
</tr>
<tr>
<td><code>jvm_gc_memory_allocated_bytes_total</code></td>
<td></td>
<td>Incremented for an increase in the size of the (young) heap memory pool after one GC to before the next.</td>
</tr>
<tr>
<td><code>jvm_gc_memory_promoted_bytes_total</code></td>
<td></td>
<td>Count of positive increases in the size of the old generation memory pool before GC to after GC.</td>
</tr>
<tr>
<td><code>jvm_gc_concurrent_phase_time_seconds_count</code></td>
<td><code>gc</code>, <code>action</code>, <code>cause</code></td>
<td>Time spent in concurrent phase.</td>
</tr>
<tr>
<td><code>jvm_gc_concurrent_phase_time_seconds_sum</code></td>
<td><code>gc</code>, <code>action</code>, <code>cause</code></td>
<td></td>
</tr>
<tr>
<td><code>jvm_gc_concurrent_phase_time_seconds_max</code></td>
<td><code>gc</code>, <code>action</code>, <code>cause</code></td>
<td></td>
</tr>
<tr>
<td><code>jvm_gc_pause_seconds_count</code></td>
<td><code>gc</code>, <code>action</code>, <code>cause</code></td>
<td>Time spent in GC pause.</td>
</tr>
<tr>
<td><code>jvm_gc_pause_seconds_sum</code></td>
<td><code>gc</code>, <code>action</code>, <code>cause</code></td>
<td></td>
</tr>
<tr>
<td><code>jvm_gc_pause_seconds_max</code></td>
<td><code>gc</code>, <code>action</code>, <code>cause</code></td>
<td></td>
</tr>
<tr>
<td><code>jvm_gc_overhead</code></td>
<td></td>
<td>The percentage of total CPU time that is spent in garbage collection activities.</td>
</tr>
<tr>
<td><code>system_cpu_count</code></td>
<td></td>
<td>The number of processors available to the Java virtual machine.</td>
</tr>
<tr>
<td><code>system_load_average_1m</code></td>
<td></td>
<td>The sum of the number of runnable entities queued to available processors and the number of runnable entities running on the available processors averaged over a period of time.</td>
</tr>
<tr>
<td><code>system_cpu_usage</code></td>
<td></td>
<td>The "recent cpu usage" of the system the application is running in.</td>
</tr>
<tr>
<td><code>process_cpu_usage</code></td>
<td></td>
<td>The "recent cpu usage" for the Java Virtual Machine process.</td>
</tr>
<tr>
<td><code>jvm_threads_peak_threads</code></td>
<td></td>
<td>The peak live thread count since the Java virtual machine started or peak was reset.</td>
</tr>
<tr>
<td><code>jvm_threads_daemon_threads</code></td>
<td></td>
<td>The current number of live daemon threads.</td>
</tr>
<tr>
<td><code>jvm_threads_live</code></td>
<td></td>
<td>The current number of live threads including both daemon and non-daemon threads.</td>
</tr>
<tr>
<td><code>jvm_threads_started_threads_total</code></td>
<td></td>
<td>The total number of application threads started in the JVM.</td>
</tr>
<tr>
<td><code>jvm_threads_states_threads</code></td>
<td><code>state</code></td>
<td>The current number of threads.</td>
</tr>
</tbody>
</table>
<h3 id="key-metrics-for-monitoring-kafka">Key Metrics for monitoring Kafka<a class="headerlink" href="#key-metrics-for-monitoring-kafka" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Metric name</th>
<th>Labels</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kafka_producer_compression_rate_avg</code></td>
<td><code>client.id</code></td>
<td>The average compression rate of record batches, defined as the average ratio of the compressed batch size over the uncompressed size.</td>
</tr>
<tr>
<td><code>kafka_producer_response_rate</code></td>
<td><code>client.id</code></td>
<td>The number of responses received per second</td>
</tr>
<tr>
<td><code>kafka_producer_request_rate</code></td>
<td><code>client.id</code></td>
<td>The number of requests sent per second</td>
</tr>
<tr>
<td><code>kafka_producer_request_latency_avg</code></td>
<td><code>client.id</code></td>
<td>The average request latency in ms</td>
</tr>
<tr>
<td><code>kafka_producer_outgoing_byte_rate</code></td>
<td><code>client.id</code></td>
<td>The number of outgoing bytes sent to all servers per second</td>
</tr>
<tr>
<td><code>kafka_producer_io_wait_time_ns_avg</code></td>
<td><code>client.id</code></td>
<td>The average length of time the I/O thread spent waiting for a socket ready for reads or writes in nanoseconds.</td>
</tr>
<tr>
<td><code>kafka_producer_batch_size_avg</code></td>
<td><code>client.id</code></td>
<td>The average number of bytes sent per partition per-request.</td>
</tr>
<tr>
<td><code>kafka_consumer_records_lag</code></td>
<td><code>client.id</code></td>
<td>Number of messages consumer is behind producer on this partition</td>
</tr>
<tr>
<td><code>kafka_consumer_records_lag_max</code></td>
<td><code>client.id</code></td>
<td>Maximum number of messages consumer is behind producer, either for a specific partition or across all partitions on this client</td>
</tr>
<tr>
<td><code>kafka_consumer_bytes_consumed_rate</code></td>
<td><code>client.id</code></td>
<td>Average number of bytes consumed per second for a specific topic or across all topics.</td>
</tr>
<tr>
<td><code>kafka_consumer_records_consumed_rate</code></td>
<td><code>client.id</code></td>
<td>Average number of records consumed per second for a specific topic or across all topics</td>
</tr>
<tr>
<td><code>kafka_consumer_fetch_rate</code></td>
<td><code>client.id</code></td>
<td>Number of fetch requests per second from the consumer</td>
</tr>
</tbody>
</table>
<h3 id="mongodb-metrics">MongoDB metrics<a class="headerlink" href="#mongodb-metrics" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Metric name</th>
<th>Labels</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mongodb_driver_pool_waitqueuesize</code></td>
<td><code>cluster_id</code>, <code>server_address</code></td>
<td>The current size of the wait queue for a connection from the pool</td>
</tr>
<tr>
<td><code>mongodb_driver_pool_checkedout</code></td>
<td><code>cluster_id</code>, <code>server_address</code></td>
<td>The count of connections that are currently in use</td>
</tr>
<tr>
<td><code>mongodb_driver_pool_size</code></td>
<td><code>cluster_id</code>, <code>server_address</code></td>
<td>The current size of the connection pool, including idle and and in-use members</td>
</tr>
<tr>
<td><code>mongodb_driver_commands_seconds_max</code></td>
<td><code>cluster_id</code>, <code>server_address</code>, <code>collection</code>, <code>command</code>, <code>status</code></td>
<td>Timer of mongodb commands</td>
</tr>
<tr>
<td><code>mongodb_driver_commands_seconds_count</code></td>
<td><code>cluster_id</code>, <code>server_address</code>, <code>collection</code>, <code>command</code>, <code>status</code></td>
<td>Timer of mongodb commands</td>
</tr>
<tr>
<td><code>mongodb_driver_commands_seconds_sum</code></td>
<td><code>cluster_id</code>, <code>server_address</code>, <code>collection</code>, <code>command</code>, <code>status</code></td>
<td>Timer of mongodb commands</td>
</tr>
</tbody>
</table>
<h2 id="tracing">Tracing<a class="headerlink" href="#tracing" title="Permanent link">&para;</a></h2>
<p>Currently, tracing is leveraged by Micrometer Tracing and OpenTelemetry in the Spring context.
OpenTelemetry (OTEL) is a collection of standardized vendor-agnostic tools, APIs, and SDKs. It's a
CNCF incubating project and is a merger of the OpenTracing and OpenCensus projects.
OpenTracing is a vendor-neutral API for sending telemetry data over to an observability backend.
It uses Micrometer for code instrumentation &amp; provide tracing bridge to OpenTelemetry and 
OpenTelemetry for tools to collect and send telemetry data to the reporter/collector.</p>
<p>Default features are:</p>
<ul>
<li>Adds trace and span ids to the Slf4J MDC, so you can extract all the logs from a given trace or
  span in a log aggregator.</li>
<li>Instruments common ingress and egress points from Spring applications (servlet filter, rest
  template, scheduled actions, message channels, feign client).</li>
<li>The service name is derived from <code>spring.application.name</code></li>
<li>Generate and report OTLP traces via HTTP or gRPC. By default, it sends them to a OTLP compatible
  collector (e.g. Jaeger) on localhost (http port 4317, gRPC port 4318). Configure the location of
  the service using <code>management.opentelemetry.tracing.export.otlp.endpoint</code>.</li>
<li>See <a href="#configuration">above</a> for more common options.</li>
<li>You can check all the possible values on <a href="https://docs.spring.io/spring-boot/api/java/org/springframework/boot/actuate/autoconfigure/tracing/otlp/OtlpTracingProperties.html">OtlpTracingProperties</a>
  and <a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/actuate/autoconfigure/tracing/TracingProperties.html">TracingProperties</a></li>
</ul>
<h2 id="health-checks-actuator">Health Checks / Actuator<a class="headerlink" href="#health-checks-actuator" title="Permanent link">&para;</a></h2>
<p>Configures the Spring Boot Actuator to be accessible on root path <code>/</code> at default management
port <code>8081</code>.</p>
<p>The following endpoints are provided at the admin management endpoint:</p>
<ul>
<li>Liveness: <code>http://{serviceURL}:{adminPort}/healthcheck/liveness</code></li>
<li>Readiness: <code>http://{serviceURL}:{adminPort}/healthcheck/readiness</code></li>
</ul>
<p>The readiness group contains the following indicators:</p>
<ul>
<li><a href="https://javadoc.io/doc/org.springframework.boot/spring-boot-actuator/latest/org/springframework/boot/actuate/availability/ReadinessStateHealthIndicator.html"><code>ReadinessStateHealthIndicator</code></a></li>
<li><a href="https://javadoc.io/doc/org.springframework.boot/spring-boot-actuator/latest/org/springframework/boot/actuate/data/mongo/MongoHealthIndicator.html"><code>MongoHealthIndicator</code></a>, if auto-configured.</li>
<li><code>OpenPolicyAgentHealthIndicator</code> if <a href="#opa">OPA</a> is enabled for authentication</li>
</ul>
<p>To overwrite the defaults <a href="https://javadoc.io/doc/org.springframework.boot/spring-boot-actuator/latest/org/springframework/boot/actuate/health/HealthIndicator.html"><code>HealthIndicator</code></a> of the readiness group, you can overwrite the property
source:</p>
<div class="language-properties highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">management.endpoint.health.group.readiness.include</span><span class="o">=</span><span class="s">readinessState, customCheck</span>
</code></pre></div></td></tr></table></div>
<p>Custom health indicators can be easily added to the application context:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Component</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomHealthIndicator</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HealthIndicator</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@Override</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Health</span><span class="w"> </span><span class="nf">health</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Health</span><span class="p">.</span><span class="na">Builder</span><span class="p">().</span><span class="na">up</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The custom health indicator will be available under <code>/healthcheck/custom</code> which is resolved by the
prefix of the <a href="https://javadoc.io/doc/org.springframework.boot/spring-boot-actuator/latest/org/springframework/boot/actuate/health/HealthIndicator.html">HealthIndicator</a>
implementing component.</p>
<h2 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h2>
<p>The Spring Boot default logging is enabled.
Logs are printed to standard out.
<code>ENABLE_JSON_LOGGING=true</code> as environment variable or <code>-Denable.json.logging=true</code> as JVM parameter
enables output as JSON for structured logs used in log aggregation tools.
To enable JSON logging in <code>application.(properties/yaml)</code>,
<code>logging.config=classpath:org/sdase/commons/spring/boot/web/logging/logback-json.xml</code> may be used.</p>
<p>The timestamp format of the json log can be configured with the environment variable 
<code>LOG_JSON_TIMESTAMP_FORMAT</code>, the default value is <code>yyyy-MM-dd HH:mm:ss.SSS</code>.</p>
<p>The <a href="https://docs.oracle.com/middleware/12211/wcs/tag-ref/MISC/TimeZones.html">timezone</a> 
of the log timestamp can be changed using the <code>TZ</code> environment variable e.g. <code>TZ=America/Belize</code>.
<strong>This will change the timezone of the whole service</strong>. In general our recommendation is to make the 
timezone part of the timestamp format and let log aggregation tools handle the timezone conversion.</p>
<h3 id="correlation-of-logs-in-distributed-systems">Correlation of Logs in Distributed Systems<a class="headerlink" href="#correlation-of-logs-in-distributed-systems" title="Permanent link">&para;</a></h3>
<p>To allow correlation of logs in distributed systems a <code>Parent-Trace-Token</code> header is added to a 
Kafka message if a <code>Trace-Token</code> is present in the MDC of the producer.
A Kafka RecordInterceptor is used to read out the header and add the <code>Parent-Trace-Token</code> to the MDC
of the consumer service.
This allows the consumer service to log the <code>Parent-Trace-Token</code> and the current <code>Trace-Token</code>
to trace the origin.
<strong>This only happens automatically if the used Listener is not a BatchListener</strong></p>
<h2 id="metadata-context">Metadata Context<a class="headerlink" href="#metadata-context" title="Permanent link">&para;</a></h2>
<p>If you want to make use of the data in the metadata context, you should read the <a href="../metadata-context/">dedicated documentation</a>.
If your service is required to support the metadata context but is not interested in the data,
continue here:</p>
<p>Services that use the sda-spring-boot-commons:</p>
<ul>
<li>can access the current <code>org.sdase.commons.spring.boot.metadata.context.MetadataContext</code> in their
  implementation</li>
<li>will automatically load the context from incoming HTTP requests into the thread, handling the
  request, if you register <code>org.sdase.commons.spring.boot.web.metadata.MetadataContextConfiguration</code></li>
<li>will automatically load the context from consumed Kafka messages into the thread handling the
  message and the error when handling the message fails when the consumer is configured with one of
  the provided <code>org.sdase.commons.spring.boot.kafka.SdaKafkaConsumerConfiguration</code></li>
<li>will automatically propagate the context to other services via HTTP when using
  a <code>org.sdase.commons.spring.boot.web.client.PlatformClient</code>:
  <div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@PlatformClient</span><span class="p">(</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;http://your-api-url&quot;</span>
<span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ClientWithMetadataConfiguration</span><span class="w"> </span><span class="p">{</span>
<span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/metadata-hello&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">Object</span><span class="w"> </span><span class="nf">getSomething</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></li>
<li>
<p>when using a FeignClient, that behaviour can be achieved by using
  the <code>org.sdase.commons.spring.boot.web.metadata.MetadataContextClientConfiguration</code>
  configuration.</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@FeignClient</span><span class="p">(</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;http://your-api-url&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">MetadataContextClientConfiguration</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ClientWithMetadataConfiguration</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/metadata-hello&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">Object</span><span class="w"> </span><span class="nf">getSomething</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</li>
</ul>
<ul>
<li>will automatically propagate the context in produced Kafka messages when the producer is created
  with <code>org.sdase.commons.spring.boot.kafka.SdaKafkaProducerConfiguration</code></li>
<li>are configurable by the property or environment variable <code>METADATA_FIELDS</code> to be aware of the
  metadata used in a specific environment</li>
</ul>
<p>Services that interrupt a business process should persist the context from
<code>MetadataContext.detachedCurrent()</code> and restore it with <code>MetadataContext.createContext()</code> when the
process continues.
Interrupting a business process means that processing is stopped and continued later in a new thread
or even another instance of the service.
Most likely, this will happen when a business entity is stored based on a request and loaded later
for further processing by a scheduler or due to a new user interaction.
In this case, the <code>DetachedMetadataContext</code> must be persisted along with the entity and recreated
when the entity is loaded.
The <code>DetachedMetadataContext</code> can be defined as field in any MongoDB entity.</p>
<p>For services that handle requests or messages in parallel, the metadata context attributes will 
be automatically transferred to the new threads, if <code>@Async</code> is used.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Overview
              </div>
            </div>
          </a>
        
        
          
          <a href="../starter-mongodb/" class="md-footer__link md-footer__link--next" aria-label="Next: Starter MongoDB">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Starter MongoDB
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.footer", "content.action.edit"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../search/main.js"></script>
      
    
  </body>
</html>