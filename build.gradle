
buildscript {
  repositories {
    maven { url "https://plugins.gradle.org/m2/" }
  }
}

plugins {
  id "jacoco"
  id "idea"
  id 'maven-publish'
  id 'signing'
  id "com.diffplug.spotless" version "6.9.1"
  id 'io.spring.dependency-management' version '1.0.11.RELEASE'
}

ext {
  springCloudVersion = "2021.0.3"
  springBootVersion = "2.7.3"
}

repositories {
  mavenCentral()
}

group "org.sdase.commons.spring.boot"


subprojects {
  apply plugin: 'jacoco'
  apply plugin: 'idea'
  apply plugin: 'java'
  apply plugin: 'java-library'
  apply plugin: 'maven-publish'
  apply plugin: 'signing'
  apply plugin: "com.diffplug.spotless"
  apply plugin: 'io.spring.dependency-management'

  repositories {
    mavenCentral()
  }

  group "org.sdase.commons.spring.boot"

  sourceCompatibility = JavaVersion.VERSION_17

  // the version of the generated jars is based on the SEMANTIC_VERSION environment variable
  version = System.getenv("SEMANTIC_VERSION")

  // Disable publication of Gradle Module Metadata
  tasks.withType(GenerateModuleMetadata) {
    enabled = false
  }

  dependencyManagement {
    imports {
      mavenBom("org.springframework.boot:spring-boot-dependencies:${springBootVersion}")
      mavenBom("org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}")
    }
  }

  test {
    useJUnitPlatform()
  }

  // configure the spotless to use the Google Java Format
  spotless {
    java {
      googleJavaFormat('1.15.0')
      enforceCheck = false
      licenseHeaderFile '../licenseHeaderFile'
    }
  }

  if (!it.name.endsWith("-example")) {

    signing {
      def signingKey = findProperty("signingKey")
      def signingPassword = findProperty("signingPassword")
      useInMemoryPgpKeys(signingKey, signingPassword)
      sign publishing.publications
    }

    tasks.withType(Sign) {
      // skip signing a publication to maven local
      onlyIf { !gradle.taskGraph.hasTask(publishMavenPublicationToMavenLocal) }
    }

    publishing {
      publications {
        maven(MavenPublication) {
          from components.java
          versionMapping {
            usage('java-api') {
              fromResolutionOf('runtimeClasspath')
            }
            usage('java-runtime') {
              fromResolutionResult()
            }
          }
          pom {
            name = project.group + ":" + project.name
            description = 'A libraries to bootstrap services easily that follow the patterns and specifications promoted by the SDA SE'
            url = 'https://github.com/SDA-SE/sda-spring-boot-commons'

            licenses {
              license {
                name = 'MIT License'
                url = 'https://raw.githubusercontent.com/SDA-SE/sda-spring-boot-commons/master/LICENSE'
              }
            }

            organization {
              name = 'SDA SE Open Industry Solutions'
              url = 'https://sda.se'
            }

            issueManagement {
              system = 'GitHub'
              url = 'https://github.com/SDA-SE/sda-spring-boot-commons/issues'
            }

            scm {
              connection = 'scm:git:https://github.com/SDA-SE/sda-spring-boot-commons.git'
              developerConnection = 'scm:git:https://github.com/SDA-SE/sda-spring-boot-commons.git'
              url = 'https://github.com/SDA-SE/sda-spring-boot-commons'
            }
          }
        }
      }

      repositories {
        maven {
          name = "sdaIntern"
          def releasesRepoUrl = "https://nexus.sda-se.io/repository/sda-se-releases/"
          def snapshotsRepoUrl = "https://nexus.sda-se.io/repository/sda-se-snapshots/"
          url = version.endsWith('-SNAPSHOT') ? snapshotsRepoUrl : releasesRepoUrl

          credentials {
            username System.getenv('SDA_NEXUS_USER')
            password System.getenv('SDA_NEXUS_PASSWORD')
          }
        }
      }
    }

  }
  // output XML reports for SonarCloud
  jacocoTestReport {
    reports {
      xml.required = true
    }
  }

}

wrapper { gradleVersion = '7.4.2' }
