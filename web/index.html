
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../s3/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.3">
    
    
      
        <title>Web - sda-spring-boot-commons</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.c4a75a56.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sda-commons-web-starter" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="sda-spring-boot-commons" class="md-header__button md-logo" aria-label="sda-spring-boot-commons" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            sda-spring-boot-commons
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Web
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
      </form>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="sda-spring-boot-commons" class="md-nav__button md-logo" aria-label="sda-spring-boot-commons" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    sda-spring-boot-commons
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Web
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web" class="md-nav__link">
    Web
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication" class="md-nav__link">
    Authentication
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authorization" class="md-nav__link">
    Authorization
  </a>
  
    <nav class="md-nav" aria-label="Authorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa" class="md-nav__link">
    OPA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-properties" class="md-nav__link">
    Configuration Properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-client" class="md-nav__link">
    Http Client
  </a>
  
    <nav class="md-nav" aria-label="Http Client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication-forwarding" class="md-nav__link">
    Authentication forwarding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trace-token" class="md-nav__link">
    Trace-Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oidc-client" class="md-nav__link">
    OIDC Client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax-rs-mapping" class="md-nav__link">
    JAX-RS Mapping
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-properties_1" class="md-nav__link">
    Configuration properties
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#platform-client" class="md-nav__link">
    Platform Client
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    Error Handling
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencing-in-openapi" class="md-nav__link">
    Referencing in OpenAPI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throwing-apiexception" class="md-nav__link">
    Throwing ApiException
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async" class="md-nav__link">
    Async
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jackson" class="md-nav__link">
    Jackson
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    Monitoring
  </a>
  
    <nav class="md-nav" aria-label="Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-properties" class="md-nav__link">
    Default properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tracing" class="md-nav__link">
    Tracing
  </a>
  
    <nav class="md-nav" aria-label="Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-properties_1" class="md-nav__link">
    Default properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#health-checks-actuator" class="md-nav__link">
    Health Checks / Actuator
  </a>
  
    <nav class="md-nav" aria-label="Health Checks / Actuator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-properties_2" class="md-nav__link">
    Default properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metadata-context" class="md-nav__link">
    Metadata Context
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../s3/" class="md-nav__link">
        S3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../mongodb/" class="md-nav__link">
        MongoDB
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../kafka/" class="md-nav__link">
        Kafka
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        Security Hardening
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web" class="md-nav__link">
    Web
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication" class="md-nav__link">
    Authentication
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authorization" class="md-nav__link">
    Authorization
  </a>
  
    <nav class="md-nav" aria-label="Authorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opa" class="md-nav__link">
    OPA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-properties" class="md-nav__link">
    Configuration Properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-client" class="md-nav__link">
    Http Client
  </a>
  
    <nav class="md-nav" aria-label="Http Client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication-forwarding" class="md-nav__link">
    Authentication forwarding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trace-token" class="md-nav__link">
    Trace-Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oidc-client" class="md-nav__link">
    OIDC Client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jax-rs-mapping" class="md-nav__link">
    JAX-RS Mapping
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-properties_1" class="md-nav__link">
    Configuration properties
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#platform-client" class="md-nav__link">
    Platform Client
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    Error Handling
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencing-in-openapi" class="md-nav__link">
    Referencing in OpenAPI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throwing-apiexception" class="md-nav__link">
    Throwing ApiException
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async" class="md-nav__link">
    Async
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jackson" class="md-nav__link">
    Jackson
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    Monitoring
  </a>
  
    <nav class="md-nav" aria-label="Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-properties" class="md-nav__link">
    Default properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tracing" class="md-nav__link">
    Tracing
  </a>
  
    <nav class="md-nav" aria-label="Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-properties_1" class="md-nav__link">
    Default properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#health-checks-actuator" class="md-nav__link">
    Health Checks / Actuator
  </a>
  
    <nav class="md-nav" aria-label="Health Checks / Actuator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-properties_2" class="md-nav__link">
    Default properties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metadata-context" class="md-nav__link">
    Metadata Context
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="sda-commons-web-starter">sda-commons-web-starter<a class="headerlink" href="#sda-commons-web-starter" title="Permanent link">&para;</a></h1>
<p>The <code>sda-commons-web-starter</code> provides several features to provide a service based
on the SDA core concepts.</p>
<p>Features:
  - <a href="#authentication">Authentication</a>
  - <a href="#authorization">Authorization</a>
  - <a href="#http-client">Http Client</a>
  - <a href="#async">Async Request Context</a>
  - <a href="#jackson">Jackson Object Mapping</a>
  - <a href="#monitoring">Monitoring</a>
  - <a href="#tracing">Tracing</a>
  - <a href="#health-checks--actuator">Health Checks</a>
  - <a href="#logging">Logging</a>
  - <a href="#metadata-context">Support for Metadata Context</a></p>
<p>Based on:
  - <code>org.springframework.boot:spring-boot-starter-web</code>
  - <code>org.springframework.boot:spring-boot-starter-oauth2-resource-server</code>
  - <code>org.springframework.boot:spring-boot-starter-oauth2-client</code>
  - <code>org.springframework.boot:spring-boot-starter-validation</code>
  - <code>org.springframework.boot:spring-boot-starter-actuator</code>
  - <code>org.springframework.cloud:spring-cloud-starter-openfeign</code>
  - <code>org.springframework.boot:spring-boot-starter-validation</code>
  - <code>org.springframework.cloud:spring-cloud-starter-sleuth</code>
  - <code>org.springframework.cloud:spring-cloud-sleuth-zipkin</code></p>
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th><strong>Property</strong></th>
<th><strong>Description</strong></th>
<th><strong>Default</strong></th>
<th><strong>Example</strong></th>
<th><strong>Env</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>auth.issuers</code> <em>string</em></td>
<td>Comma separated string of open id discovery key sources with required issuers.</td>
<td></td>
<td><code>https://iam-int.dev.de/auth/realms/123</code></td>
<td><code>AUTH_ISSUERS</code></td>
</tr>
<tr>
<td><code>auth.disable</code> <em>boolean</em></td>
<td>Disables authorization checks completely.</td>
<td><code>false</code></td>
<td><code>true</code></td>
<td><code>AUTH_DISABLE</code></td>
</tr>
<tr>
<td><code>opa.disable</code> <em>boolean</em></td>
<td>Disables authorization checks with Open Policy Agent completely.</td>
<td><code>false</code></td>
<td><code>true</code></td>
<td><code>OPA_DISABLE</code></td>
</tr>
<tr>
<td><code>opa.base.url</code> <em>string</em></td>
<td>The baseUrl of OPA.</td>
<td><code>http://localhost:8181</code></td>
<td><code>http://opa-service:8181</code></td>
<td><code>OPA_BASE_URL</code></td>
</tr>
<tr>
<td><code>opa.policy.package</code> <em>string</em></td>
<td>The policy package to check for authorization.</td>
<td>Defaults to package name of <code>@SpringBootApplication</code> annotated class</td>
<td><code>com.custom.package.name</code></td>
<td><code>OPA_POLICY_PACKAGE</code></td>
</tr>
<tr>
<td><code>opa.exclude.patterns</code> <em>string</em></td>
<td>Custom excluded paths can be configured as comma separated list of regex.</td>
<td><code>openapi.json</code> and <code>openapi.yaml</code></td>
<td><code>/customPathOne,/customPathTwo</code></td>
<td><code>OPA_EXCLUDE_PATTERNS</code></td>
</tr>
<tr>
<td><code>opa.client.connection.timeout</code> <em>string</em></td>
<td>The connection timeout of the client that calls the Open Policy Agent server.</td>
<td><code>500ms</code></td>
<td><code>2s</code></td>
<td><code>OPA_CLIENT_CONNECTION_TIMEOUT</code></td>
</tr>
<tr>
<td><code>opa.client.timeout</code> <em>string</em></td>
<td>The read timeout of the client that calls the Open Policy Agent server.</td>
<td><code>500ms</code></td>
<td><code>2s</code></td>
<td><code>OPA_CLIENT_TIMEOUT</code></td>
</tr>
<tr>
<td><code>oidc.client.enabled</code> <em>boolean</em></td>
<td>Enables OIDC Authentication (Client Credentials Flow) for the configured clients.</td>
<td><code>false</code></td>
<td><code>true</code></td>
<td><code>OIDC_CLIENT_ENABLED</code></td>
</tr>
<tr>
<td><code>oidc.client.id</code> <em>string</em></td>
<td>The client ID for the registration.</td>
<td>``</td>
<td><code>exampleClient</code></td>
<td><code>OPA_CLIENT_ID</code></td>
</tr>
<tr>
<td><code>oid.client.secret</code> <em>string</em></td>
<td>The Client secret of the registration.</td>
<td>``</td>
<td><code>s3cret</code></td>
<td><code>OIDC_CLIENT_SECRET</code></td>
</tr>
<tr>
<td><code>oidc.client.issuer.uri</code> <em>string</em></td>
<td>URI that can either be an OpenID Connect discovery endpoint or an OAuth 2.0 Authorization Server Metadata endpoint defined by RFC 8414.</td>
<td>``</td>
<td><code>https://keycloak.sdadev.sda-se.io/auth/realms/exampleRealm</code></td>
<td><code>OIDC_CLIENT_ISSUER_URI</code></td>
</tr>
<tr>
<td><code>cors.allowed-origin-patterns</code> <em>string</em></td>
<td>Comma separated list of URL patterns for which CORS requests are allowed.</td>
<td><em>none allowed</em></td>
<td><code>https://*.all-subdomains.com, https://static-domain.com</code></td>
<td><code>CORS_ALLOWEDORIGINPATTERNS</code></td>
</tr>
<tr>
<td><code>request.body.max.size</code> <em>size</em></td>
<td>The maximum size allowed for request body data sent by a client.</td>
<td><em>1 MB</em></td>
<td><code>100 KB</code>, <code>10MB</code></td>
<td><code>REQUEST_BODY_MAX_SIZE</code></td>
</tr>
<tr>
<td><code>enable.json.logging</code> <em>boolean</em></td>
<td>If logs should be printed as JSON. <em>Note: This config param is not available for application.properties or application.yaml</em></td>
<td><em>false</em></td>
<td><code>true</code></td>
<td><code>ENABLE_JSON_LOGGING</code></td>
</tr>
</tbody>
</table>
<p>For further information have a look at the <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#documentation">Spring Boot documentation</a>.</p>
<h2 id="web">Web<a class="headerlink" href="#web" title="Permanent link">&para;</a></h2>
<p>The list of web configurations: </p>
<ul>
<li>The<code>server.servlet.context-path</code> defaults to <code>/api</code></li>
<li>The<code>server.port</code> defaults to <code>8080</code></li>
<li>The<code>managment.server.port</code> defaults to <code>8081</code></li>
<li>The <code>openapi.yaml</code> is available under <code>/api/openapi.yaml</code></li>
</ul>
<p><strong>Please make sure to configure <code>spring.application.name</code> for every service</strong></p>
<h2 id="authentication">Authentication<a class="headerlink" href="#authentication" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#web.security">Spring Security Documentation</a></li>
</ul>
<p>Enables feature that make a Spring Boot service compliant with the
<a href="https://sda.dev/core-concepts/security-concept/authentication/">SDA SE Authentication</a> concepts
using OIDC.</p>
<p>OIDC Authentication can be configured with <code>auth.issuers</code> to provide a comma separated
list of trusted issuers. In develop and test environments, the boolean <code>auth.disable</code> may
be used to disable authentication.</p>
<p>The JWKS URI of each issuer is updated when an unknown Key ID is received and every 5 minutes. The
cache of known JWK is invalidated after 15 minutes.</p>
<p><strong>This setup allows authenticated and anonymous requests! It is the responsibility of policies
provided by the Open Policy Agent to decide about denying anonymous requests.</strong></p>
<p>Spring Security is disabled for the Management/Admin Port (default: 8081). Be aware that these port
should not be accessible out of the deployment context.</p>
<p>This security implementation lacks some features compared to <a href="https://github.com/SDA-SE/sda-dropwizard-commons/tree/master/sda-commons-server-auth">sda-dropwizard-commons</a>:
- No configuration of static local public keys to verify the token signature. 
- No configuration of JWKS URIs to verify the token signature. 
- The IDP must provide an <code>iss</code> claim that matches the base URI for discovery. 
- Leeway is not configurable yet. 
- The client that loads the JWKS is not configurable yet.</p>
<h2 id="authorization">Authorization<a class="headerlink" href="#authorization" title="Permanent link">&para;</a></h2>
<p>Enables feature that make a Spring Boot service compliant with the
<a href="https://sda.dev/core-concepts/security-concept/authorization/">SDA SE Authorization</a> concepts
using Open Policy Agent.</p>
<p>The authorization is done by the <a href="https://www.openpolicyagent.org/">Open Policy Agent</a>. It can be 
configured as described in
<a href="sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/auth/opa/OpaAccessDecisionVoter.java">OpaAccessDecisionVoter#OpaAccessDecisionVoter
(boolean, String, String, OpaRequestBuilder, RestTemplate, ApplicationContext, io.opentracing.Tracer)
</a>
and <a href="sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/auth/opa/OpaRestTemplateConfiguration.java">OpaRestTemplateConfiguration#OpaRestTemplateConfiguration(Duration, Duration)
</a>.</p>
<p>The OPA configuration acts as a client to the Open Policy Agent and is hooked in as request filter (
Access Decision Manager) which is part of the <code>SecurityFilterChain</code> including the OIDC
Authentication.</p>
<p>Constraints provided with the Open Policy Agent response can be mapped to a custom POJO. If the
class extends <a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/auth/opa/AbstractConstraints.java"><code>AbstractConstraints</code></a> 
and is annotated with <a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/auth/opa/Constraints.java"><code>@Constraints</code></a> it can be
<a href="https://javadoc.io/doc/org.springframework/spring-beans/latest/org/springframework/beans/factory/annotation/Autowired.html"><code>@Autowired</code></a> 
in <a href="https://javadoc.io/doc/org.springframework/spring-webmvc/latest/org/springframework/web/servlet/mvc/Controller.html"><code>@Controllers</code></a> 
or <a href="https://javadoc.io/doc/org.springframework/spring-web/latest/org/springframework/web/bind/annotation/RestController.html"><code>@RestControllers</code></a>.</p>
<p><div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Constraints</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyConstraints</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractConstraints</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">MyConstraints</span><span class="w"> </span><span class="nf">setAdmin</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">admin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAdmin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@RestController</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthTestApp</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MyConstraints</span><span class="w"> </span><span class="n">myConstraints</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<p>Additional parameters that are needed for the authorization decision may be provided with custom
<a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/auth/opa/extension/OpaInputExtension.java">OpaInputExtensions</a>.</p>
<h3 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h3>
<p>The testing module provides aligned test dependencies including Wiremock for external APIs and 
JUnit extensions to mock or disable authentication and authorization.</p>
<h3 id="opa">OPA<a class="headerlink" href="#opa" title="Permanent link">&para;</a></h3>
<p><img alt="Overview" src="assets/overview_opa.svg" /></p>
<p>The OPA configuration requests the policy decision providing the following inputs</p>
<ul>
<li>HTTP path as Array</li>
<li>HTTP method as String</li>
<li>validated JWT (if available)</li>
<li>all request headers</li>
</ul>
<p><em>Remark to HTTP request headers:</em><br />
The configuration normalizes header names to lower case to simplify handling in OPA since HTTP
specification defines header names as case-insensitive.
Multivalued headers are not normalized with respect to the representation as list or single string
with separator char.
They are forwarded as parsed by the framework.</p>
<p><em>Security note:</em>
Please be aware while a service might only consider one value of a specific header, the OPA is able
to authorize on a array of those.
Consider this in your policy when you want to make sure you authorize on the same value that a
service might use to evaluate the output.</p>
<p>These <a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/auth/opa/model/OpaInput.java">inputs</a>
can be accessed inside a policy <code>.rego</code>-file in this way:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code># each policy lies in a package that is referenced in the configuration of the OpaBundle
package example

# decode the JWT as new variable &#39;token&#39;
token = {&quot;payload&quot;: payload} {
    not input.jwt == null
    io.jwt.decode(input.jwt, [_, payload, _])
}

# deny by default
default allow = false

allow {
    # allow if path match &#39;/contracts/:anyid&#39; 
    input.path = [&quot;contracts&quot;, _]

    # allow if request method &#39;GET&#39; is used
    input.httpMethod == &quot;GET&quot;

    # allow if &#39;claim&#39; exists in the JWT payload
    token.payload.claim

    # allow if a request header &#39;HttpRequestHeaderName&#39; has a certain value 
    input.headers[&quot;httprequestheadername&quot;][_] == &quot;certain-value&quot;
}

# set some example constraints 
constraint1 := true                # always true
constraint2 := [ &quot;v2.1&quot;, &quot;v2.2&quot; ]  # always an array of &quot;v2.1&quot; and &quot;v2.2&quot;
constraint3[token.payload.sub]     # always a set that contains the &#39;sub&#39; claim from the token
                                   # or is empty if no token is present
</code></pre></div></td></tr></table></div>
<p>The response consists of two parts: The overall <code>allow</code> decision, and optional rules that represent <em>constraints</em> to limit data access
within the service. These constraints are fully service dependent and MUST be applied when querying the database or
filtering received data.</p>
<p>The following listing presents a sample OPA result with a positive allow decision and two constraints, the first with boolean value and second
with a list of string values.
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;allow&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;constraint1&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;constraint2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;v2.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;v2.2&quot;</span><span class="w"> </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;constraint3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;my-sub&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<h3 id="configuration-properties">Configuration Properties<a class="headerlink" href="#configuration-properties" title="Permanent link">&para;</a></h3>
<ul>
<li><code>opa.disable</code> <em>boolean</em><ul>
<li>Disables authorization checks with Open Policy Agent completely. In this case access to all
  resources is granted but no constraints are provided.</li>
</ul>
</li>
<li><code>opa.base.url</code> <em>string</em><ul>
<li>The base url of the Open Policy Agent Server. Defaults to <code>http://localhost:8181</code>.
  Requests to the server are determined by the base URL and the policy package. Given the default
  base URL <code>http://localhost:8181</code> and an example package of <code>com.my.service</code>, the Open Policy Agent
  server will be requested for authorization decision
  at <code>http://localhost:8181/v1/data/com/my/package</code></li>
</ul>
</li>
<li><code>opa.policy.package</code> <em>string</em><ul>
<li>The policy package to check for authorization. It will be reformatted to a URL path to request
  the authorization form the Open Policy Agent server. Example: <code>com.my.service</code>. If the policy
  package is blank, the package of the application class (the first bean found that is annotated
  with <code>@SpringBootApplication</code>) is used as a default. Be aware that moving the class causes a
  breaking change regarding deployment if the package is not explicitly set.
  Requests to the server are determined by the base URL and the policy package. Given the default
  base URL <code>http://localhost:8181</code> and an example package of <code>com.my.service</code>, the Open Policy Agent
  server will be requested for authorization decision
  at <code>http://localhost:8181/v1/data/com/my/package</code></li>
</ul>
</li>
<li><code>opa.exclude.patterns</code> <em>string</em><ul>
<li><code>/openapi.yaml</code> and <code>/openapi.json</code> are excluded from authorization requirements. Custom excluded
  paths can be configured as comma separated list of regex. This will overwrite the default
  excludes of the OpenAPI documentation paths.</li>
</ul>
</li>
<li><code>opa.client.timeout</code> <em>string</em><ul>
<li>The read timeout of the client that calls the Open Policy Agent server. Defaults to 500ms.</li>
</ul>
</li>
<li><code>opa.client.connection.timeout</code> <em>string</em><ul>
<li>The connection timeout of the client that calls the Open Policy Agent server. Defaults to 500ms.</li>
</ul>
</li>
</ul>
<h2 id="http-client">Http Client<a class="headerlink" href="#http-client" title="Permanent link">&para;</a></h2>
<p>Enables support for <a href="https://javadoc.io/doc/org.springframework.cloud/spring-cloud-openfeign-core/3.1.6/index.html"><code>org.springframework.cloud.openfeign.FeignClients</code></a> 
that support SDA Platform features like:</p>
<p>- passing the Authorization header to downstream services.
  - passing the Trace-Token header to downstream services.
  - OIDC client authentication</p>
<p>A feign client can be created as interface like this:
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@FeignClient</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;partnerOds&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${partnerOds.baseUrl}&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">OtherServiceClient</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/partners&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Partner</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPartners</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
Then the spring boot application needs to be annotated with <code>@EnableFeignClients</code> in order for the component 
scanning to pick up the <code>@FeignClient</code> annotated interfaces like so
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@EnableFeignClients</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ExampleApplication</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(...)</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<p>The Partner ODS base url must be configured as <code>http://partner-ods:8080/api</code> in the Spring
environment property <code>partnerOds.baseUrl</code>. Detailed configuration like timeouts can be configured
with <a href="https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/#spring-cloud-feign-overriding-defaults">default feign properties</a> 
in the <code>application.yaml</code> or <code>derived environment</code> properties based on the <code>name</code> attribute of the 
<a href="https://javadoc.io/doc/org.springframework.cloud/spring-cloud-openfeign-core/3.1.6/index.html"><code>org.springframework.cloud.openfeign.FeignClient</code></a> 
annotation.</p>
<p>The client is then available as bean in the Spring context.</p>
<h3 id="authentication-forwarding">Authentication forwarding<a class="headerlink" href="#authentication-forwarding" title="Permanent link">&para;</a></h3>
<p>The client can be used within the SDA Platform to path through the received authentication header by
adding a configuration:
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@FeignClient</span><span class="p">(</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;partnerOds&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${partnerOds.baseUrl}&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">AuthenticationPassThroughClientConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">}</span>
<span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">OtherServiceClient</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/partners&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Partner</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPartners</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<p><a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/client/AuthenticationPassThroughClientConfiguration.java"><code>AuthenticationPassThroughClientConfiguration</code></a> 
will take the <strong>Authorization</strong> header from the current request context of the servlet and 
adds its value to the client request.</p>
<h3 id="trace-token">Trace-Token<a class="headerlink" href="#trace-token" title="Permanent link">&para;</a></h3>
<p>The client can be used within the SDA Platform to pass through the received <code>Trace-Token</code> header by adding a configuration:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@FeignClient</span><span class="p">(</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;partnerOds&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${partnerOds.baseUrl}&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">SdaTraceTokenClientConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">}</span>
<span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">OtherServiceClient</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/partners&quot;</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Partner</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPartners</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/tracing/SdaTraceTokenClientConfiguration.java">SdaTraceTokenClientConfiguration</a>
will take the <code>Trace-Token</code> header from the current request context of the servlet and adds its value to the client request.</p>
<p>If no <code>Trace-Token</code> header is present in the current request context, the <a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/tracing/SdaTraceTokenClientConfiguration.java">SdaTraceTokenClientConfiguration</a>
will generate a new Trace-Token and pass it to the following requests.</p>
<h3 id="oidc-client">OIDC Client<a class="headerlink" href="#oidc-client" title="Permanent link">&para;</a></h3>
<p>If the request context is not always existing, e.g. in cases where a technical user for
service-to-service communication is required, the <a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/client/OidcClientRequestConfiguration.java"><code>OidcClientRequestConfiguration</code></a> 
will request the required OIDC authentication token with the client credentials flow using the 
configured <code>"oidc.client.issuer.uri"</code>, <code>"oidc.client.id"</code> and <code>"oidc.client.secret"</code>.</p>
<p>If the current request context contains the <strong>Authorization</strong> header, the authentication pass-through
will be applied instead.</p>
<h3 id="jax-rs-mapping">JAX-RS Mapping<a class="headerlink" href="#jax-rs-mapping" title="Permanent link">&para;</a></h3>
<p>If you would like to use JAX-RS based web annotations, you just need to apply
the <code>feign.jaxrs2.JAXRS2Contract.class</code> to configurations.</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;customers&quot;</span><span class="p">)</span>
<span class="nd">@FeignClient</span><span class="p">(</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;customerService&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${customer.api.base.url}&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">OidcClientRequestConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">feign</span><span class="p">.</span><span class="na">jaxrs2</span><span class="p">.</span><span class="na">JAXRS2Contract</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CustomerServiceApi</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nd">@POST</span>
<span class="w">  </span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/{customerId}/contracts&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nd">@Consumes</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">addContract</span><span class="p">(</span>
<span class="w">      </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&quot;customerId&quot;</span><span class="p">)</span><span class="w"> </span><span class="nd">@NotBlank</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">customerId</span><span class="p">,</span>
<span class="w">      </span><span class="n">Contract</span><span class="w"> </span><span class="n">contract</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="configuration-properties_1">Configuration properties<a class="headerlink" href="#configuration-properties_1" title="Permanent link">&para;</a></h3>
<ul>
<li><code>oidc.client.enabled</code> <em>boolean</em><ul>
<li>Enables OIDC Authentication (Client Credentials Flow) for the configured clients.
  If enabled, provide a client id, secret and an issuer url.</li>
<li>Example: <code>true</code></li>
<li>Default: <code>false</code></li>
</ul>
</li>
<li><code>oidc.client.id</code> <em>string</em><ul>
<li>Client ID for the registration</li>
<li>Example: <code>oidcClient</code></li>
<li>Default: ``</li>
</ul>
</li>
<li><code>oid.client.secret</code> <em>string</em><ul>
<li>Client secret of the registration.</li>
<li>Example: <code>s3cret</code></li>
<li>Default: ``</li>
</ul>
</li>
<li><code>oidc.client.issuer.uri</code> <em>string</em><ul>
<li>URI that can either be an OpenID Connect discovery endpoint
  or an OAuth 2.0 Authorization Server Metadata endpoint defined by RFC 8414.</li>
<li>Example: <code>https://keycloak.sdadev.sda-se.io/auth/realms/exampleRealm</code></li>
<li>Default: ``</li>
</ul>
</li>
</ul>
<h3 id="platform-client">Platform Client<a class="headerlink" href="#platform-client" title="Permanent link">&para;</a></h3>
<p>The Platform Client combines the authentication forwarding, trace token and OIDC configuration
without the need to configure each individually.</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@PlatformClient</span><span class="p">(</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;customerService&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;${customer.api.base.url}&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CustomerServiceApi</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>It abstracts some configuration of the FeignClient and is then available as bean as well.</p>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<p>The <code>sda-commons-web-starter</code> provides a shared <code>ApiError</code> model, to provide a common
response error structure for SDA-restful services.</p>
<h3 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h3>
<p>Per default, the <code>sda-commons-web-starter</code> autoconfigures a
global <code>@ExceptionHandler(ApiException.class)</code> as <code>@ControllerAdvice</code>. As a result, the
exception handler is per default provided to every <code>@Controller</code>.</p>
<h4 id="referencing-in-openapi">Referencing in OpenAPI<a class="headerlink" href="#referencing-in-openapi" title="Permanent link">&para;</a></h4>
<p>To provide the common <code>ApiError</code> in the API, you need to reference the class as <code>@Schema</code>.</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>@ApiResponse(
    responseCode = &quot;422&quot;,
    description =
        &quot;The request could not be processed due to invalid parameters. Details are provided in the error response.&quot;,
    content = @Content(schema = @Schema(implementation = ApiError.class)))
</code></pre></div></td></tr></table></div>
<h4 id="throwing-apiexception">Throwing ApiException<a class="headerlink" href="#throwing-apiexception" title="Permanent link">&para;</a></h4>
<p>When the <code>ApiException</code> is thrown the <code>@ExceptionHandler</code> automatically intercepts the exception and
maps the related <code>ResponseEntity</code>. As the result, the controller returns the related http response
code and the nested <code>ApiError</code>.</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>    throw ApiException.builder()
      .httpCode(422)
      .title(&quot;Invalid input&quot;)
      .detail(&quot;name&quot;, &quot;name was not null&quot;, &quot;NOT_NULL&quot;)
      .cause(e)
      .build();
</code></pre></div></td></tr></table></div>
<p>In this example the controller would return with http status <code>422</code> and body:</p>
<div class="language-json highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Invalid input&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;invalidParams&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;reason&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name was not null&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;errorCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NOT_NULL&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="async">Async<a class="headerlink" href="#async" title="Permanent link">&para;</a></h2>
<p>The default Spring <a href="https://javadoc.io/doc/org.springframework/spring-context/latest/org/springframework/scheduling/annotation/Async.html">async</a> 
task executor is autoconfigured to transfer the request attributes of the 
current request to the <strong>Thread</strong> running the asynchronous method.</p>
<h2 id="jackson">Jackson<a class="headerlink" href="#jackson" title="Permanent link">&para;</a></h2>
<p>Enables feature that make a Spring Boot service compliant with
the <a href="https://sda.dev/core-concepts/communication/restful-api-guide/">SDA SE RESTful API Guide</a> .
So far this covers:
- the tolerant reader pattern
- consistent serialization of <code>java.time.ZonedDateTime</code> compatible to the <a href="https://json-schema.org/understanding-json-schema/reference/string.html#dates-and-times">type <code>date-time</code> of JSON-Schema</a>.
  It is strongly recommended to use
  - <code>java.time.LocalDate</code> for dates without time serialized as <code>2018-09-23</code>
  - <code>java.time.ZonedDateTime</code> for date and times serialized as <code>2018-09-23T14:21:41+01:00</code>
  - <code>java.time.Duration</code> for durations with time resolution serialized as <code>P1DT13M</code>
  - <code>java.time.Period</code> for durations with day resolution serialized as <code>P1Y2D</code></p>
<p>All these types can be read and written in JSON as ISO 8601 formats.
Reading <code>java.time.ZonedDateTime</code> is configured to be tolerant so that added nanoseconds or missing
milliseconds or missing seconds are supported.</p>
<p><code>@com.fasterxml.jackson.annotation.JsonFormat(pattern = "...")</code> should not be used for customizing
serialization because it breaks tolerant reading of formatting variants. If a specific field should
be serialized with milliseconds, it must be annotated with
<code>@com.fasterxml.jackson.databind.annotation.JsonSerialize(using = Iso8601Serializer.WithMillis.class)</code>
. If a specific field should be serialized with nanoseconds, it must be annotated with
<code>@com.fasterxml.jackson.databind.annotation.JsonSerialize(using = Iso8601Serializer.WithNanos.class)</code></p>
<p><strong>Differences to the known <a href="https://github.com/SDA-SE/sda-dropwizard-commons/tree/master/sda-commons-server-jackson">SDA Dropwizard Commons configuration</a></strong>
- <code>java.time.ZonedDateTime</code> fields are serialized with seconds by default.
  There is no other global configuration for <strong>java.time.ZonedDateTime</strong> serialization available.
- <strong>Less modules are activated for foreign frameworks</strong>. Compared to SDA Dropwizard Commons,
  <strong>GuavaExtrasModule, JodaModule, and CaffeineModule</strong> are not registered anymore. 
- No documented customization of the global <strong>com.fasterxml.jackson.databind.ObjectMapper</strong> is available right now. 
- Support for <strong>HAL Links and embedding linked resources</strong> is not implemented. 
- Support for <strong>YAML</strong> is not implemented. 
- There is <strong>no support for <a href="https://sda.dev/core-concepts/communication/restful-api-guide/#RESTfulAPIGuide-MAY%3AProvidefieldfilteringtoretrievepartialresources">field filters</a></strong>.
  Such filters have been barely used in the SDA SE.</p>
<h2 id="monitoring">Monitoring<a class="headerlink" href="#monitoring" title="Permanent link">&para;</a></h2>
<p>TODO PROMETHEUS</p>
<p>Prometheus Metrics: <code>http://{serviceURL}:{adminPort}/metrics/prometheus</code></p>
<h3 id="default-properties">Default properties<a class="headerlink" href="#default-properties" title="Permanent link">&para;</a></h3>
<div class="language-properties highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># Metrics</span>
<span class="na">management.endpoints.web.path-mapping.prometheus</span><span class="o">=</span><span class="s">metrics/prometheus</span>
<span class="na">management.metrics.web.server.request.autotime.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="na">management.endpoint.prometheus.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="na">management.endpoint.metrics.enabled</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
<h2 id="tracing">Tracing<a class="headerlink" href="#tracing" title="Permanent link">&para;</a></h2>
<p>Currently, tracing is leveraged by Sleuth in the Spring context. Spring Cloud Sleuth provides Spring
Boot autoconfiguration for distributed tracing. Sleuth was built around Zipkin traces and so only
supports forwarding them to Zipkin (Thrift via Brave) format for now. But since Jaeger supports
Zipkin traces and the OpenTracing Jaeger Spring support is not heavily maintained, there is a need
to stick with Sleuth. However, Spring Sleuth is compatible with OpenTracing, so we can use the
standardized interfaces, hence the OpenTracing <a href="https://javadoc.io/doc/io.opentracing/opentracing-api/0.32.0/io/opentracing/Tracer.html">io.opentracing.Tracer</a> is on classpath.</p>
<p>Even if Jaeger supports the Zipkin B3 propagation format, Sleuth is forced to just use per default
the <a href="https://www.w3.org/TR/trace-context">W3C context propagation</a></p>
<p>Default features are:</p>
<ul>
<li>Adds trace and span ids to the Slf4J MDC, so you can extract all the logs from a given trace or
  span in a log aggregator.</li>
<li>Instruments common ingress and egress points from Spring applications (servlet filter, rest
  template, scheduled actions, message channels, feign client).</li>
<li>The service name is derived from <code>spring.application.name</code></li>
<li>Generate and report Jaeger-compatible traces via HTTP. By default, it sends them to a Zipkin
  collector on localhost (port 9411). Configure the location of the service using <code>spring.zipkin.base-url</code>.</li>
</ul>
<ul>
<li><code>spring.zipkin.base.url</code> <em>string</em><ul>
<li>Base url to Zipkin or Zipkin Collector of Jaeger instance.
  In case of Jaeger, the Zipkin collector
  must be enabled manually.</li>
<li>Example: <code>http://jaeger:9411</code></li>
<li>Default: <code>http://localhost:9411</code></li>
</ul>
</li>
<li><code>spring.zipkin.enabled</code> <em>boolean</em><ul>
<li>For testing purposes it's may required to disable tracing.</li>
<li>Example: <code>false</code></li>
<li>Default: <code>true</code></li>
</ul>
</li>
</ul>
<h3 id="default-properties_1">Default properties<a class="headerlink" href="#default-properties_1" title="Permanent link">&para;</a></h3>
<div class="language-properties highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">spring.sleuth.propagation.type</span><span class="o">=</span><span class="s">W3C, B3</span>
<span class="na">spring.sleuth.opentracing.enabled</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
<h2 id="health-checks-actuator">Health Checks / Actuator<a class="headerlink" href="#health-checks-actuator" title="Permanent link">&para;</a></h2>
<p>Enable features that make a Spring Boot service compliant with
the <a href="https://sda.dev/developer-guide/deployment/health-checks/">SDA SE Health Checks</a>.</p>
<p>Configures the Spring Boot Actuator to be accessible on root path <code>/</code> at default management
port <code>8081</code>.</p>
<p>The following endpoints are provided at the admin management endpoint:</p>
<ul>
<li>Liveness: <code>http://{serviceURL}:{adminPort}/healthcheck/liveness</code></li>
<li>Readiness: <code>http://{serviceURL}:{adminPort}/healthcheck/readiness</code></li>
</ul>
<p>The readiness group contains the following indicators:</p>
<ul>
<li><a href="https://javadoc.io/doc/org.springframework.boot/spring-boot-actuator/latest/org/springframework/boot/actuate/availability/ReadinessStateHealthIndicator.html"><code>ReadinessStateHealthIndicator</code></a></li>
<li><a href="https://javadoc.io/doc/org.springframework.boot/spring-boot-actuator/latest/org/springframework/boot/actuate/data/mongo/MongoHealthIndicator.html"><code>MongoHealthIndicator</code></a>, if auto-configured.</li>
<li><code>OpenPolicyAgentHealthIndicator</code> if <a href="#opa">OPA</a> is enabled for authentication</li>
</ul>
<p>To overwrite the defaults <a href="https://javadoc.io/doc/org.springframework.boot/spring-boot-actuator/latest/org/springframework/boot/actuate/health/HealthIndicator.html"><code>HealthIndicator</code></a> of the readiness group, you can overwrite the property
source:</p>
<div class="language-properties highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">management.endpoint.health.group.readiness.include</span><span class="o">=</span><span class="s">readinessState, customCheck</span>
</code></pre></div></td></tr></table></div>
<p>Custom health indicators can be easily added to the application context:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Component</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomHealthIndicator</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HealthIndicator</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nd">@Override</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Health</span><span class="w"> </span><span class="nf">health</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Health</span><span class="p">.</span><span class="na">Builder</span><span class="p">().</span><span class="na">up</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The custom health indicator will be available under <code>/healthcheck/custom</code> which is resolved by the
prefix of the <a href="https://javadoc.io/doc/org.springframework.boot/spring-boot-actuator/latest/org/springframework/boot/actuate/health/HealthIndicator.html">HealthIndicator</a>
implementing component.</p>
<h3 id="default-properties_2">Default properties<a class="headerlink" href="#default-properties_2" title="Permanent link">&para;</a></h3>
<div class="language-properties highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># Actuator</span>
<span class="na">management.server.port</span><span class="o">=</span><span class="s">8081</span>
<span class="na">management.server.servlet.context-path</span><span class="o">=</span><span class="s">/</span>
<span class="na">management.endpoints.web.base-path</span><span class="o">=</span><span class="s">/</span>
<span class="na">management.endpoints.web.exposure.include</span><span class="o">=</span><span class="s">*</span>
<span class="na">management.endpoints.enabled-by-default</span><span class="o">=</span><span class="s">false</span>
<span class="c1"># Healthcheck</span>
<span class="na">management.endpoint.health.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="na">management.endpoints.web.path-mapping.health</span><span class="o">=</span><span class="s">healthcheck</span>
<span class="na">management.endpoint.health.probes.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="c1"># Add the required auto configured health indicators which are supported in org.sdase.commons.spring</span>
<span class="c1"># See https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.health.auto-configured-health-indicators</span>
<span class="c1"># to see the available indicators. If an included HealthIndicator is not autoconfigured, it will be automatically ignored</span>
<span class="na">management.endpoint.health.group.readiness.include</span><span class="o">=</span><span class="s">readinessState, mongo</span>
<span class="na">management.endpoint.health.show-details</span><span class="o">=</span><span class="s">always</span>
<span class="na">management.endpoint.health.show-components</span><span class="o">=</span><span class="s">always</span>
</code></pre></div></td></tr></table></div>
<h2 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h2>
<p>The Spring Boot default logging is enabled.
Logs are printed to standard out.
<code>ENABLE_JSON_LOGGING=true</code> as environment variable or <code>-Denable.json.logging=true</code> as JVM parameter
enables output as JSON for structured logs used in log aggregation tools.
To enable JSON logging in <code>application.(properties/yaml)</code>,
<code>logging.config=classpath:org/sdase/commons/spring/boot/web/logging/logback-json.xml</code> may be used. </p>
<h2 id="metadata-context">Metadata Context<a class="headerlink" href="#metadata-context" title="Permanent link">&para;</a></h2>
<p>If you want to make use of the data in the metadata context, you should read the <a href="../../sda-commons-web-autoconfigure/docs/metadata-context.md">dedicated documentation</a>.
If your service is required to support the metadata context but is not interested in the data,
continue here:</p>
<p>Services that use the sda-spring-boot-commons:
- can access the current <a href="../../sda-commons-metadata-context/src/main/java/org/sdase/commons/spring/boot/metadata/context/MetadataContext.java">MetadataContext</a>
  in their implementation
- will automatically load the context from incoming HTTP requests into the thread handling the
  request, if you register <a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/metadata/MetadataContextConfiguration.java">MetadataContextConfiguration</a>
- will automatically load the context from consumed Kafka messages into the thread handling the
  message and the error when handling the message fails when the consumer is configured with one of
  the
  provided <a href="../../sda-commons-starter-kafka/src/main/java/org/sdase/commons/spring/boot/kafka/SdaKafkaConsumerConfiguration.java">SdaKafkaConsumerConfiguration</a>
- will automatically propagate the context to other services via HTTP when using a platform client
  that uses
  the <a href="../../sda-commons-web-autoconfigure/src/main/java/org/sdase/commons/spring/boot/web/metadata/MetadataContextConfiguration.java">MetadataContextClientConfiguration</a>
  configuration, e.g:
  - ```java
    @FeignClient(
    value = "name",
    url = "<a href="http://your-api-url">http://your-api-url</a>",
    configuration = {
      MetadataContextClientConfiguration.class
    })
    public interface ClientWithMetadataConfiguration {</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>@GetMapping(&quot;/metadata-hello&quot;)
Object getSomething();
}
```
</code></pre></div></td></tr></table></div>
<ul>
<li>will automatically propagate the context in produced Kafka messages when the producer is created
  with <a href="../../sda-commons-starter-kafka/src/main/java/org/sdase/commons/spring/boot/kafka/SdaKafkaProducerConfiguration.java">SdaKafkaProducerConfiguration</a></li>
<li>are configurable by the property or environment variable <code>METADATA_FIELDS</code> to be aware of the
  metadata used in a specific environment</li>
</ul>
<p>Services that interrupt a business process should persist the context from
<code>MetadataContext.detachedCurrent()</code> and restore it with <code>MetadataContext.createContext(…)</code> when the
process continues.
Interrupting a business process means that processing is stopped and continued later in a new thread
or even another instance of the service.
Most likely, this will happen when a business entity is stored based on a request and loaded later
for further processing by a scheduler or due to a new user interaction.
In this case, the <code>DetachedMetadataContext</code> must be persisted along with the entity and recreated
when the entity is loaded.
The <code>DetachedMetadataContext</code> can be defined as field in any MongoDB entity.</p>
<p>For services that handle requests or messages in parallel, the metadata context attributes will 
be automatically transferred to the new threads, if <code>@Async</code> is used.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                Overview
              </div>
            </div>
          </a>
        
        
          
          <a href="../s3/" class="md-footer__link md-footer__link--next" aria-label="Next: S3" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                S3
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.footer", "content.action.edit"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.efa0ade1.min.js"></script>
      
        <script src="../search/main.js"></script>
      
    
  </body>
</html>